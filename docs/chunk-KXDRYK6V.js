import{m as J}from"./chunk-FLJJF36S.js";import{a as S,b as Tr,c as Ir}from"./chunk-IZXJ5OQA.js";import{d as Hr}from"./chunk-ZP7N7TL4.js";import{Q as c,W as i,Yb as Dr,Zb as Ur,_ as F,fa as G,ga as vr,k as L,o as U,pa as Lr}from"./chunk-GNHLBSKU.js";import{a as p,b as R}from"./chunk-7CGTOI24.js";var N=class o extends S{constructor(){super("store.currentPlayers",[])}convertStateToStored(e){return e.map(r=>R(p({},r),{statuses:Array.from(r.statuses)}))}convertStoredToState(e){return e.map(r=>R(p({},r),{statuses:new Set(r.statuses)}))}static{this.\u0275fac=function(r){return new(r||o)}}static{this.\u0275prov=c({token:o,factory:o.\u0275fac,providedIn:"root"})}};var Q=class o extends S{constructor(){super("store.currentRoundConfig",null)}static{this.\u0275fac=function(r){return new(r||o)}}static{this.\u0275prov=c({token:o,factory:o.\u0275fac,providedIn:"root"})}};var M=class o extends S{constructor(){super("store.dayCount",1)}static{this.\u0275fac=function(r){return new(r||o)}}static{this.\u0275prov=c({token:o,factory:o.\u0275fac,providedIn:"root"})}};var Sr=["LOUP_GAROU","GRAND_MECHANT_LOUP","LOUP_BLANC","PERE_LOUPS"];var K=class o extends S{constructor(){super("store.announcementsQueue",[])}static{this.\u0275fac=function(r){return new(r||o)}}static{this.\u0275prov=c({token:o,factory:o.\u0275fac,providedIn:"root"})}};var Or={0:{header:"Morts \xE0 annoncer"},1:{header:"Grognement de l'ours",message:"L'ours du montreur d'ours grogne"},3:{header:"Reniflement du renard",message:"<p>Non, ce groupe ne contient aucun loup-garou.</p><p>Le renard perd son pouvoir.</p>"},2:{header:"Reniflement du renard",message:"<p>Oui, ce groupe contient un loup-garou.</p><p>Le renard garde son pouvoir.</p>"},4:{header:"Perte des pouvoirs",message:"<p>L'Ancien du village a \xE9t\xE9 tu\xE9 par des innocents.</p><p>Tous les innocents perdent leurs pouvoirs.</p>"},5:{header:"Idiot graci\xE9",message:"<p>Les villageois d\xE9cide de gracier l'Idiot.</p><p>L'Idiot ne pourra plus voter.</p>"},6:{header:"Mort par l'\xE9p\xE9e rouill\xE9e",message:"{{ playerName }} a \xE9t\xE9 tu\xE9 par l'\xE9p\xE9e rouill\xE9e du chevalier."}};var H=class o{constructor(){this.destroyRef=i(vr);this.modalService=i(J);this.announcementsQueue=i(K).state;this.isPresenting=Lr(!1);Ur(()=>{this.announcementsQueue().length>0&&!this.isPresenting()&&this.showNextAnnouncement()})}announceDeaths(e){let t={header:"Morts \xE0 annoncer",message:`<ul>${e.map(n=>`<li>${n.name}</li>`).join("")}</ul>`};this.addAnnouncementToQueue(t)}announce(e,r){let t=Or[e].message;t!==void 0&&r!==void 0&&Object.entries(r).forEach(([a,s])=>{let O=`{{\\s*${a}\\s*}}`,_=new RegExp(O,"g");t=t.replaceAll(_,s)});let n={header:Or[e].header,message:t};this.addAnnouncementToQueue(n)}addAnnouncementToQueue(e){this.announcementsQueue.update(r=>[...r,e])}showNextAnnouncement(){this.isPresenting.set(!0);let e=this.announcementsQueue()[0];if(e===void 0){this.isPresenting.set(!1);return}this.announcementsQueue.update(r=>r.slice(1)),this.modalService.showTextModal(e).pipe(Ir(this.destroyRef)).subscribe(()=>{this.isPresenting.set(!1)})}static{this.\u0275fac=function(r){return new(r||o)}}static{this.\u0275prov=c({token:o,factory:o.\u0275fac,providedIn:"root"})}};var T=class o extends S{constructor(){super("store.afterDeathRoundQueue",[])}static{this.\u0275fac=function(r){return new(r||o)}}static{this.\u0275prov=c({token:o,factory:o.\u0275fac,providedIn:"root"})}};var q=class o extends S{constructor(){super("store.deathsToAnnounce",[])}convertStateToStored(e){return e.map(r=>R(p({},r),{statuses:Array.from(r.statuses)}))}convertStoredToState(e){return e.map(r=>R(p({},r),{statuses:new Set(r.statuses)}))}static{this.\u0275fac=function(r){return new(r||o)}}static{this.\u0275prov=c({token:o,factory:o.\u0275fac,providedIn:"root"})}};var $=class o extends S{constructor(){super("store.knownDeaths",new Set)}convertStateToStored(e){return Array.from(e)}convertStoredToState(e){return new Set(e)}static{this.\u0275fac=function(r){return new(r||o)}}static{this.\u0275prov=c({token:o,factory:o.\u0275fac,providedIn:"root"})}};var z=["LOUP_GAROU","GRAND_MECHANT_LOUP","LOUP_BLANC","PERE_LOUPS"];var Z=["CHASSEUR","CUPIDON","PETITE_FILLE","SORCIERE","VOYANTE","CORBEAU","SALVATEUR","MONTREUR_OURS","RENARD","CHEVALIER","BOUC"];var P=(o,e)=>R(p({},o),{statuses:new Set([...o.statuses,e])}),v=(o,e)=>{let r=new Set(o.statuses);return r.delete(e),R(p({},o),{statuses:r})},I=(o,e,r)=>o.map(t=>r.includes(t.id)?P(t,e):t),C=(o,e,r)=>o.map(t=>r.includes(t.id)?v(t,e):t);function _r(o,e){let r=o.map(n=>n.role);return[...e.selectedRoles,"VILLAGEOIS","LOUP_GAROU"].filter(n=>!r.includes(n))}function A(o){return z.includes(o.role)||o.statuses.has("INFECTED")}function ee(o){return o.killedBy!==void 0&&["CHASSEUR","SORCIERE","VILLAGEOIS"].includes(o.killedBy)}function Nr(o){return o.map(e=>{if(e.role==="SORCIERE"){let r=v(e,"HEALTH_POTION");return r=v(r,"DEATH_POTION"),r.role="VILLAGEOIS",r}return Z.includes(e.role)?R(p({},e),{role:"VILLAGEOIS"}):e})}var Cr={NOT_SELECTED:[],VILLAGEOIS:[],LOUP_GAROU:[],CHASSEUR:["CHASSEUR"],CUPIDON:["CUPIDON","AMOUREUX"],PETITE_FILLE:[],SORCIERE:["SORCIERE_HEALTH","SORCIERE_KILL"],VOYANTE:["VOYANTE"],JOUEUR_FLUTE:["JOUEUR_FLUTE","CHARMED"],CORBEAU:["CORBEAU"],ENFANT_SAUVAGE:["ENFANT_SAUVAGE"],SALVATEUR:["SALVATEUR"],GRAND_MECHANT_LOUP:["GRAND_MECHANT_LOUP"],MONTREUR_OURS:["MONTREUR_OURS"],RENARD:["RENARD"],CHIEN_LOUP:["CHIEN_LOUP"],SOEUR:["SOEURS"],FRERE:["FRERES"],LOUP_BLANC:["LOUP_BLANC"],VOLEUR:["VOLEUR"],ANGE:[],ANCIEN:[],IDIOT:[],CHEVALIER:[],BOUC:["BOUC"],SECTAIRE:["SECTAIRE"],PERE_LOUPS:["PERE_LOUPS"]};var u=class{constructor(e,r,t,n=0){this.roundRole=e;this.isOnlyOnce=r;this.isDuringDay=t;this.type=n}handleAction(e,r){let t=[...e];return r.forEach(n=>{let a=t.findIndex(s=>s.id===n);if(a>-1){let s=this.affectSelectedPlayer(t[a]);t[a]=s}}),L(t)}getRoundConfig(e,r){return{round:this.roundRole,selectablePlayers:this.getSelectablePlayers(e).map(t=>t.id),selectableRoles:this.getSelectableRoles(e,r),maxSelectable:this.getMaxSelectable(e),minSelectable:this.getMinSelectable(e),isDuringDay:this.isDuringDay,type:this.type}}getSelectablePlayers(e){return[]}getSelectableRoles(e,r){return[]}getMaxSelectable(e){return this.getSelectablePlayers(e).length}getMinSelectable(e){return 0}affectSelectedPlayer(e){return e}};var re=class extends u{constructor(){super("AMOUREUX",!0,!1)}};var te=class extends u{constructor(){super("BOUC",!0,!0,1)}handleAction(e,r){let t=e.reduce((a,s)=>!s.isDead&&!r.includes(s.id)?[...a,s.id]:a,[]),n=I(e,"NO_VOTE",t);return L(n)}getSelectablePlayers(e){return e.filter(r=>!r.isDead)}};var oe=class extends u{constructor(){super("CAPITAINE",!0,!0,1)}getSelectablePlayers(e){return e.filter(r=>!r.isDead)}getMaxSelectable(e){return 1}getMinSelectable(e){return 1}affectSelectedPlayer(e){return P(e,"CAPTAIN")}};var ne=class extends u{constructor(){super("CHARMED",!1,!1)}};var ae=class extends u{constructor(){super("CHASSEUR",!0,!0,1)}getSelectablePlayers(e){return e.filter(r=>r.role!=="CHASSEUR"&&!r.isDead)}getMaxSelectable(e){return 1}getMinSelectable(e){return 1}affectSelectedPlayer(e){return R(p({},e),{isDead:!0,killedBy:"CHASSEUR"})}};var ie=class extends u{constructor(){super("CHIEN_LOUP",!0,!1,3)}handleAction(e,r,t){let n=[...e],a=n.findIndex(s=>s.role==="CHIEN_LOUP");if(a>-1&&t!==void 0){let s=R(p({},n[a]),{role:t});n[a]=s}return L(n)}getSelectablePlayers(e){return e.filter(r=>r.role==="CHIEN_LOUP")}getSelectableRoles(){return["VILLAGEOIS","LOUP_GAROU"]}getMaxSelectable(e){return 1}getMinSelectable(e){return 1}};var se=class extends u{constructor(){super("CORBEAU",!1,!1,1)}getSelectablePlayers(e){return e.filter(r=>r.role!=="CORBEAU"&&!r.isDead)}getMaxSelectable(e){return 1}getMinSelectable(e){return 1}affectSelectedPlayer(e){return P(e,"RAVEN")}};var le=class extends u{constructor(){super("CUPIDON",!0,!1,1)}getSelectablePlayers(e){return e}getMaxSelectable(e){return 2}getMinSelectable(e){return 2}affectSelectedPlayer(e){return P(e,"LOVER")}};var de=class extends u{constructor(){super("ENFANT_SAUVAGE",!0,!1,1)}getSelectablePlayers(e){return e.filter(r=>r.role!=="ENFANT_SAUVAGE")}getMaxSelectable(e){return 1}getMinSelectable(e){return 1}affectSelectedPlayer(e){return P(e,"CHILD_MODEL")}};var ue=class extends u{constructor(){super("FRERES",!0,!1)}};var me=class extends u{constructor(){super("GRAND_MECHANT_LOUP",!1,!1,1)}getSelectablePlayers(e){return e.some(t=>A(t)&&t.isDead)?[]:e.filter(t=>!A(t)&&!t.isDead&&!t.statuses.has("WOLF_TARGET"))}getMaxSelectable(e){return 1}affectSelectedPlayer(e){let r=P(e,"WOLF_TARGET");return r.killedBy="GRAND_MECHANT_LOUP",r}};var ce=class extends u{constructor(){super("JOUEUR_FLUTE",!1,!1,1)}getSelectablePlayers(e){return e.filter(r=>r.role!=="JOUEUR_FLUTE"&&!r.isDead&&!r.statuses.has("CHARMED"))}getMaxSelectable(e){return 2}affectSelectedPlayer(e){return P(e,"CHARMED")}};var fe=class extends u{constructor(){super("LOUP_BLANC",!1,!1,1)}getSelectablePlayers(e){return e.filter(r=>A(r)&&r.role!=="LOUP_BLANC"&&!r.isDead)}getMaxSelectable(e){return 1}affectSelectedPlayer(e){return R(p({},e),{isDead:!0,killedBy:"LOUP_BLANC"})}};var Ee=class extends u{constructor(){super("LOUP_GAROU",!1,!1,1)}getSelectablePlayers(e){return this.areAllLoupGarouDead(e)?[]:e.filter(t=>!A(t)&&!t.isDead)}getMaxSelectable(e){return 1}getMinSelectable(e){return this.areAllLoupGarouDead(e)?0:1}affectSelectedPlayer(e){let r=P(e,"WOLF_TARGET");return r.killedBy="LOUP_GAROU",r}areAllLoupGarouDead(e){return e.filter(A).every(r=>r.isDead)}};function w(o,e,r=!1){let t=o.find((n,a)=>a>e&&!n.isDead&&(!r||A(n)));return t===void 0&&e>0&&(t=o.find((n,a)=>a<e&&!n.isDead&&(!r||A(n)))),t}function pe(o,e){let r=e-1;r<0&&(r=o.length-1);let t;do t=o[r],r--,r<0&&(r=o.length-1);while(t.isDead&&r!==e);return t}var Re=class extends u{constructor(){super("MONTREUR_OURS",!1,!0,2);this.announcementService=i(H)}handleAction(r,t){let n=r.findIndex(a=>a.role==="MONTREUR_OURS");if(n>-1){if(r[n].statuses.has("INFECTED"))return this.announcementService.announce(1),L([...r]);let s=w(r,n);if(A(s))return this.announcementService.announce(1),L([...r]);let O=pe(r,n);A(O)&&this.announcementService.announce(1)}return L([...r])}};var ye=class extends u{constructor(){super("PERE_LOUPS",!1,!1,1)}handleAction(e,r){return super.handleAction(e,r).pipe(U(t=>{let n=[...t];if(r.length>0){let a=n.find(O=>O.role==="PERE_LOUPS")?.id;a!==void 0&&(n=I(n,"NO_POWER",[a]));let s=n.findIndex(O=>O.id===r[0]);s>-1&&n[s].role==="JOUEUR_FLUTE"&&(n[s]=R(p({},n[s]),{role:"LOUP_GAROU"}))}return n}))}getSelectablePlayers(e){return this.canInfect(e)?e.filter(r=>r.statuses.has("WOLF_TARGET")):[]}getMaxSelectable(e){return 1}affectSelectedPlayer(e){let r=v(e,"WOLF_TARGET");return r=P(r,"INFECTED"),r.killedBy=void 0,r}canInfect(e){return!(e.find(r=>r.role==="PERE_LOUPS")?.statuses.has("NO_POWER")??!1)}};var Pe=class extends u{constructor(){super("RENARD",!1,!1,1);this.announcementService=i(H)}handleAction(r,t){let n=[...r];if(t.length>0)if(this.isFoxActionSuccess(r,t[0]))this.announcementService.announce(2);else{this.announcementService.announce(3);let a=n.findIndex(s=>s.role==="RENARD");a>-1&&(n[a]=P(n[a],"NO_POWER"))}return L(n)}getSelectablePlayers(r){return r.filter(t=>!t.isDead)}getMaxSelectable(r){return r.find(t=>t.role==="RENARD")?.statuses.has("NO_POWER")?0:1}isFoxActionSuccess(r,t){let n=r[t];if(A(n))return!0;let a=w(r,t);if(A(a))return!0;let s=pe(r,t);return A(s)}};var Se=class extends u{constructor(){super("SALVATEUR",!1,!1,1)}handleAction(e,r){return super.handleAction(e,r).pipe(U(t=>{let n=t.findIndex(a=>a.statuses.has("PROTECTED")&&!r.includes(a.id));return n>-1&&(t[n]=v(t[n],"PROTECTED")),t}))}getSelectablePlayers(e){return e.filter(r=>!r.isDead&&!r.statuses.has("PROTECTED"))}getMaxSelectable(e){return 1}getMinSelectable(e){return 1}affectSelectedPlayer(e){return P(e,"PROTECTED")}};var Oe=class extends u{constructor(){super("SECTAIRE",!0,!1,1)}handleAction(e,r){let t=e.map(n=>{let a=r.includes(n.id);return P(n,a?"BLUE_TEAM":"RED_TEAM")});return L(t)}getSelectablePlayers(e){return e}getMaxSelectable(e){return e.length-1}getMinSelectable(e){return 1}};var Ae=class extends u{constructor(){super("SOEURS",!0,!1)}};var he=class extends u{constructor(){super("SORCIERE_HEALTH",!1,!1,1)}handleAction(e,r){return super.handleAction(e,r).pipe(U(t=>{if(r.length>0){let n=t.findIndex(a=>a.role==="SORCIERE");n>-1&&(t[n]=v(t[n],"HEALTH_POTION"))}return t}))}getSelectablePlayers(e){return this.canHeal(e)?e.filter(r=>r.statuses.has("DEVOURED")):[]}getMaxSelectable(e){return 1}affectSelectedPlayer(e){let r=v(e,"DEVOURED");return r.killedBy=void 0,r}canHeal(e){return e.find(r=>r.role==="SORCIERE")?.statuses.has("HEALTH_POTION")??!1}};var ve=class extends u{constructor(){super("SORCIERE_KILL",!1,!1,1)}handleAction(e,r){return super.handleAction(e,r).pipe(U(t=>{if(r.length>0){let n=t.findIndex(a=>a.role==="SORCIERE");n>-1&&(t[n]=v(t[n],"DEATH_POTION"))}return t}))}getSelectablePlayers(e){return this.canKill(e)?e.filter(r=>r.role!=="SORCIERE"&&!r.isDead):[]}getMaxSelectable(e){return 1}affectSelectedPlayer(e){return R(p({},e),{isDead:!0,killedBy:"SORCIERE"})}canKill(e){return e.find(r=>r.role==="SORCIERE")?.statuses.has("DEATH_POTION")??!1}};var Le=class extends u{constructor(){super("VILLAGEOIS",!1,!0,1);this.announcementService=i(H)}handleAction(r,t,n,a){if(a){let s=this.handleEquality(r);return L(s)}return super.handleAction(r,t)}getSelectablePlayers(r){return this.canVote(r)?r.filter(t=>!t.isDead):[]}getMaxSelectable(r){return 1}getMinSelectable(r){return this.canVote(r)?1:0}affectSelectedPlayer(r){let t=R(p({},r),{statuses:new Set(r.statuses)});return t.role==="IDIOT"&&t.killedBy===void 0&&!t.statuses.has("INFECTED")?(t.statuses.add("NO_VOTE"),this.announcementService.announce(5)):t.isDead=!0,t.killedBy="VILLAGEOIS",t}canVote(r){return r.some(t=>!t.isDead&&!t.statuses.has("NO_VOTE"))}handleEquality(r){let t=[...r],n=t.findIndex(a=>a.role==="BOUC");return n>-1&&(t[n]=R(p({},t[n]),{isDead:!0,killedBy:void 0})),t}};function br(o,e){let r=o.map(s=>s.card),t=[],n=e.villageois-r.filter(s=>s==="VILLAGEOIS").length;for(let s=0;s<n;s++)t.push("VILLAGEOIS");let a=e.loupGarou-r.filter(s=>s==="LOUP_GAROU").length;for(let s=0;s<a;s++)t.push("LOUP_GAROU");if(e.selectedRoles.has("SOEUR")){let s=2-r.filter(O=>O==="SOEUR").length;for(let O=0;O<s;O++)t.push("SOEUR")}if(e.selectedRoles.has("FRERE")){let s=3-r.filter(O=>O==="FRERE").length;for(let O=0;O<s;O++)t.push("FRERE")}return Array.from(e.selectedRoles).filter(s=>s!=="SOEUR"&&s!=="FRERE").forEach(s=>{r.includes(s)||t.push(s)}),t}var De=class extends u{constructor(){super("VOLEUR",!0,!1,3)}handleAction(e,r,t){let n=[...e],a=n.findIndex(s=>s.card==="VOLEUR");return a>-1&&t!==void 0&&(n[a]=R(p({},n[a]),{role:t,card:t})),L(n)}getSelectablePlayers(e){return e.filter(r=>r.role==="VOLEUR")}getSelectableRoles(e,r){if(r===void 0)throw new Error("VoleurRoundHandler need cardList");let t=br(e,r);if(t.length!==2)throw new Error("Incorrect number of cards not played");return t.every(a=>z.includes(a))?t:[...t,"VOLEUR"]}getMaxSelectable(e){return 1}getMinSelectable(e){return 1}};var Ue=class extends u{constructor(){super("VOYANTE",!1,!1,1);this.modalService=i(J)}handleAction(r,t){if(t.length===0)return L(r);let n=r.find(a=>a.id===t[0]).card;return this.modalService.showPlayerCard(n).pipe(U(()=>[...r]))}getSelectablePlayers(r){return r.filter(t=>t.role!=="VOYANTE"&&!t.isDead)}getMaxSelectable(r){return 1}};var Y={AMOUREUX:re,BOUC:te,CAPITAINE:oe,CHARMED:ne,CHASSEUR:ae,CHIEN_LOUP:ie,CORBEAU:se,CUPIDON:le,ENFANT_SAUVAGE:de,FRERES:ue,GRAND_MECHANT_LOUP:me,JOUEUR_FLUTE:ce,LOUP_BLANC:fe,LOUP_GAROU:Ee,MONTREUR_OURS:Re,PERE_LOUPS:ye,RENARD:Pe,SALVATEUR:Se,SECTAIRE:Oe,SOEURS:Ae,SORCIERE_HEALTH:he,SORCIERE_KILL:ve,VILLAGEOIS:Le,VOLEUR:De,VOYANTE:Ue};var He=class o extends S{constructor(){super("store.defaultRoundHandlers",new Set)}convertStateToStored(e){return Array.from(e)}convertStoredToState(e){return new Set(e)}static{this.\u0275fac=function(r){return new(r||o)}}static{this.\u0275prov=c({token:o,factory:o.\u0275fac,providedIn:"root"})}};var Te=class o extends S{constructor(){super("store.roundHandlers",new Set)}convertStateToStored(e){return Array.from(e)}convertStoredToState(e){return new Set(e)}static{this.\u0275fac=function(r){return new(r||o)}}static{this.\u0275prov=c({token:o,factory:o.\u0275fac,providedIn:"root"})}};var b=class o{constructor(){this.injector=i(G);this.roundHandlers=new Map;this.roundHandlersState=i(Te).state;this.defaultRoundHandlersState=i(He).state;this.roundHandlersState().forEach(e=>this.createRoundHandler(e)),this.defaultRoundHandlersState().forEach(e=>this.createDefaultRoundHandler(e))}initRequiredHandlers(){this.createRoundHandler("VILLAGEOIS"),this.createRoundHandler("LOUP_GAROU"),this.createRoundHandler("CAPITAINE")}initAsDefaultHandlers(e){new Set(e).forEach(t=>{Cr[t].forEach(n=>this.createDefaultRoundHandler(n))})}getHandler(e){return this.roundHandlers.get(e)}removeHandlersByRoles(e){let r=new Set(e);Array.from(r.values()).flatMap(n=>d[n]?.rounds??[]).forEach(n=>this.removeHandler(n))}clearHandlers(){this.roundHandlers.clear(),this.roundHandlersState.set(new Set),this.defaultRoundHandlersState.set(new Set)}removeHandler(e){this.roundHandlers.delete(e),this.roundHandlersState().has(e)&&this.roundHandlersState.update(r=>(r.delete(e),new Set(r))),this.defaultRoundHandlersState().has(e)&&this.defaultRoundHandlersState.update(r=>(r.delete(e),new Set(r)))}createRoundHandler(e){if(!this.roundHandlers.has(e)){if(Y[e]===void 0)throw new Error(`Missing RoundHandler config for ${e}`);F(this.injector,()=>{let r=new Y[e];this.roundHandlers.set(e,r),this.roundHandlersState.update(t=>new Set([...t,e]))})}}createDefaultRoundHandler(e){if(!this.roundHandlers.has(e)){if(Y[e]===void 0)throw new Error(`Missing RoundHandler config for ${e}`);F(this.injector,()=>{let r=new Y[e],t=new u(e,r.isOnlyOnce,r.isDuringDay);this.roundHandlers.set(e,t),this.defaultRoundHandlersState.update(n=>new Set([...n,e]))})}}static{this.\u0275fac=function(r){return new(r||o)}}static{this.\u0275prov=c({token:o,factory:o.\u0275fac,providedIn:"root"})}};var xr={NOT_SELECTED:[],VILLAGEOIS:[],LOUP_GAROU:["WOLF_TARGET","DEVOURED"],CHASSEUR:[],CUPIDON:["LOVER"],PETITE_FILLE:[],SORCIERE:["HEALTH_POTION","DEATH_POTION"],VOLEUR:[],VOYANTE:[],JOUEUR_FLUTE:["CHARMED"],CORBEAU:["RAVEN"],ENFANT_SAUVAGE:["CHILD_MODEL"],SALVATEUR:["PROTECTED"],GRAND_MECHANT_LOUP:["WOLF_TARGET","DEVOURED"],MONTREUR_OURS:[],RENARD:["NO_POWER"],CHIEN_LOUP:["WOLF_TARGET","DEVOURED"],SOEUR:[],FRERE:[],LOUP_BLANC:["WOLF_TARGET","DEVOURED"],ANGE:[],ANCIEN:["INJURED"],IDIOT:["NO_VOTE"],CHEVALIER:["RUSTY_SWORD"],BOUC:["NO_VOTE"],SECTAIRE:["BLUE_TEAM","RED_TEAM"],PERE_LOUPS:["WOLF_TARGET","NO_POWER","INFECTED","DEVOURED"]};var y=class{handleDeath(e,r){return e}triggerAction(e){return e}};var Ie=class extends y{constructor(){super(...arguments);this.afterDeathRoundQueue=i(T).state}handleDeath(r,t){return t.role!=="IDIOT"?(this.afterDeathRoundQueue.update(n=>[...n,"CAPITAINE"]),C(r,"CAPTAIN",[t.id])):r}};var _e=class extends y{handleDeath(e,r){let t=[...e],n=t.findIndex(a=>a.role==="ENFANT_SAUVAGE");return n!==-1&&!t[n].isDead&&(t[n]=R(p({},t[n]),{role:"LOUP_GAROU"})),t}};var Ne=class extends y{triggerAction(e){return e.map(r=>{if(r.statuses.has("DEVOURED")){let t=v(r,"DEVOURED");return t.isDead=!0,t}return r})}};var Ce=class extends y{triggerAction(e){let r=e.findIndex(n=>n.role==="ANCIEN"),t=e[r];if(t?.statuses.has("INFECTED")&&!t?.statuses.has("INJURED")){let n=[...e];return n[r]=v(n[r],"INFECTED"),n[r]=P(n[r],"INJURED"),n}return e}};var gr=["NONE","ANGE","AMOUREUX","SECTAIRE","LOUP_BLANC","JOUEUR_FLUTE","LOUP_GAROU","VILLAGEOIS"];var be=class{isVictorious(e){let r=e.filter(t=>!t.isDead);return r.length===2&&r.every(t=>t.statuses.has("LOVER"))}};var xe=class{isVictorious(e,r){return r&&(e.find(t=>t.role==="ANGE")?.isDead??!1)}};var ge=class{isVictorious(e){let r=!e.find(n=>n.role==="JOUEUR_FLUTE")?.isDead,t=e.filter(n=>!n.isDead&&n.role!=="JOUEUR_FLUTE").every(n=>n.statuses.has("CHARMED"));return r&&t}};var Ve=class{isVictorious(e){let r=e.filter(t=>!t.isDead);return r.length===1&&r[0].role==="LOUP_BLANC"}};var Fe=class{isVictorious(e){return e.filter(r=>!r.isDead).every(A)}};var Ge=class{isVictorious(e){return e.filter(r=>!r.isDead).length===0}};var Me=class{isVictorious(e){let r=e.find(t=>t.role==="SECTAIRE");if(r){let t=r.statuses.has("BLUE_TEAM")?"BLUE_TEAM":"RED_TEAM";return!r.isDead&&e.filter(n=>!n.statuses.has(t)).every(n=>n.isDead)}return!1}};var we=class{isVictorious(e){return e.filter(r=>!r.isDead).every(r=>!A(r))}};var Ar={NONE:Ge,ANGE:xe,AMOUREUX:be,JOUEUR_FLUTE:ge,LOUP_BLANC:Ve,LOUP_GAROU:Fe,SECTAIRE:Me,VILLAGEOIS:we};var Be=class o extends S{constructor(){super("store.victoryHandlers",new Set)}convertStateToStored(e){return Array.from(e)}convertStoredToState(e){return new Set(e)}static{this.\u0275fac=function(r){return new(r||o)}}static{this.\u0275prov=c({token:o,factory:o.\u0275fac,providedIn:"root"})}};var g=class o{constructor(){this.victoryHandlers=new Map;this.victoryHandlersState=i(Be).state;this.victoryPriorities=gr;this.victoryHandlersState().forEach(e=>this.createVictoryHandler(e))}initRequiredHandlers(){this.createVictoryHandler("NONE"),this.createVictoryHandler("VILLAGEOIS")}removeHandler(e){this.victoryHandlers.delete(e),this.syncState()}getVictory(e,r){let t;for(let n of this.victoryPriorities)if(this.victoryHandlers.get(n)?.isVictorious(e,r)){t=n;break}return t}clearHandlers(){this.victoryHandlers.clear(),this.syncState()}createVictoryHandler(e){!this.victoryHandlers.has(e)&&Ar[e]!==void 0&&(this.victoryHandlers.set(e,new Ar[e]),this.syncState())}syncState(){this.victoryHandlersState.set(new Set(this.victoryHandlers.keys()))}static{this.\u0275fac=function(r){return new(r||o)}}static{this.\u0275prov=c({token:o,factory:o.\u0275fac,providedIn:"root"})}};var je=class extends y{constructor(){super(...arguments);this.victoryHandlersService=i(g)}handleDeath(r,t){let n=[...r],a=n.findIndex(s=>s.statuses.has("LOVER")&&s.id!==t.id&&!s.isDead);return a>-1&&(n[a]=R(p({},n[a]),{isDead:!0})),this.victoryHandlersService.removeHandler("AMOUREUX"),n}};var We=class extends y{triggerAction(e){let r=e.findIndex(t=>t.statuses.has("RUSTY_SWORD"));if(r>-1){let t=[...e];return t[r]=v(t[r],"RUSTY_SWORD"),t[r].isDead=!0,t[r].killedBy="CHEVALIER",t}return e}};var ke=class extends y{triggerAction(e){return e.map(r=>{if(r.statuses.has("WOLF_TARGET")){let t=v(r,"WOLF_TARGET");return!r.statuses.has("PROTECTED")||r.role==="PETITE_FILLE"?r.role==="ANCIEN"&&!r.statuses.has("INJURED")?t=P(t,"INJURED"):t=P(t,"DEVOURED"):t.killedBy=void 0,t}return r})}};var Vr={WOLF_TARGET:ke,HEALTH_POTION:y,DEATH_POTION:y,CAPTAIN:Ie,LOVER:je,INJURED:y,PROTECTED:y,NO_POWER:y,CHARMED:y,CHILD_MODEL:_e,RAVEN:y,NO_VOTE:y,RUSTY_SWORD:We,BLUE_TEAM:y,RED_TEAM:y,INFECTED:Ce,DEVOURED:Ne};var V=class o{constructor(){this.injector=i(G);this.currentPlayersState=i(N).state.asReadonly();this.statusHandlers=new Map;this.defaultStatusHandler=new y;let e=this.currentPlayersState();e.length>0&&this.initHandlers(e)}initHandlers(e){this.createStatusHandler("CAPTAIN"),e.forEach(r=>{xr[r.role]?.forEach(t=>this.createStatusHandler(t))})}getHandler(e){if(this.statusHandlers.has(e))return this.statusHandlers.get(e);throw new Error(`StatusHandler for ${e} not initialized`)}clearHandlers(){this.statusHandlers.clear()}createStatusHandler(e){if(this.statusHandlers.has(e))return;let r=Vr[e];if(r===void 0)throw new Error(`Missing StatusHandler config for ${e}`);if(r.name===y.name){this.statusHandlers.set(e,this.defaultStatusHandler);return}F(this.injector,()=>{let t=new r;this.statusHandlers.set(e,t)})}static{this.\u0275fac=function(r){return new(r||o)}}static{this.\u0275prov=c({token:o,factory:o.\u0275fac,providedIn:"root"})}};var m=class{constructor(e,r){this.role=e;this.metadata=r;this.roundHandlersService=i(b);this.statusHandlersService=i(V);this.victoryHandlersService=i(g)}prepareNewGame(e){return this.initRoundHandlers(),this.initStatusHandlers(),this.initVictoryHandlers(),e}handleDeath(e,r){return this.metadata.rounds.forEach(t=>this.roundHandlersService.removeHandler(t)),e}cleanStatusesAfterDay(e){return e}initRoundHandlers(){this.metadata.rounds.forEach(e=>this.roundHandlersService.createRoundHandler(e))}initStatusHandlers(){this.metadata.statuses.forEach(e=>this.statusHandlersService.createStatusHandler(e))}initVictoryHandlers(){this.metadata.victories.forEach(e=>this.victoryHandlersService.createVictoryHandler(e))}};var Ye=class extends m{constructor(){super("ANCIEN",d.ANCIEN)}handleDeath(e,r){return ee(r)?(this.roundHandlersService.removeHandlersByRoles(Z),Nr(e)):e}};var hr=["SECTAIRE","VOLEUR","CUPIDON","VOYANTE","RENARD","AMOUREUX","SOEURS","FRERES","ENFANT_SAUVAGE","CORBEAU","SALVATEUR","CHIEN_LOUP","LOUP_GAROU","LOUP_BLANC","PERE_LOUPS","GRAND_MECHANT_LOUP","SORCIERE_HEALTH","SORCIERE_KILL","JOUEUR_FLUTE","CHARMED","MONTREUR_OURS","CAPITAINE","VILLAGEOIS"];var Je=class o extends S{constructor(){super("store.beforeDeathRound",null)}static{this.\u0275fac=function(r){return new(r||o)}}static{this.\u0275prov=c({token:o,factory:o.\u0275fac,providedIn:"root"})}};var Qe=class o extends S{constructor(){super("store.uniqueRoundsPassed",new Set)}convertStateToStored(e){return Array.from(e)}convertStoredToState(e){return new Set(e)}static{this.\u0275fac=function(r){return new(r||o)}}static{this.\u0275prov=c({token:o,factory:o.\u0275fac,providedIn:"root"})}};var B=class o{constructor(){this.roundHandlersService=i(b);this.deathService=i(j);this.sortedRounds=[...hr];this.uniqueRoundsPassed=i(Qe).state;this.beforeDeathRound=i(Je).state;this.dayCount=i(M).state.asReadonly()}resetRounds(){this.uniqueRoundsPassed.set(new Set),this.beforeDeathRound.set(null)}getNextRound(e){this.roundHandlersService.getHandler(e)?.isOnlyOnce&&this.uniqueRoundsPassed.update(Gr=>new Set([...Gr,e]));let t=this.deathService.getNextAfterDeathRound();if(t!==void 0)return this.beforeDeathRound.set(e),t;let n=this.beforeDeathRound();n&&(e=n,this.beforeDeathRound.set(null));let a=this.sortedRounds.indexOf(e),s,O=a+1;O>this.sortedRounds.length-1&&(O=0);let _;do _=this.sortedRounds[O],s=this.roundHandlersService.getHandler(_),O++,O>this.sortedRounds.length-1&&(O=0);while((s===void 0||this.uniqueRoundsPassed().has(_))&&O!==a);if(s===void 0||this.uniqueRoundsPassed().has(_))throw new Error("No next round found");return _==="LOUP_BLANC"&&this.dayCount()%2!==0?this.getNextRound("LOUP_BLANC"):_}getFirstRound(){let e,r=0,t;do if(t=this.sortedRounds[r],e=this.roundHandlersService.getHandler(t),r++,r>this.sortedRounds.length-1)throw new Error("No first round found");while(e===void 0);return t}setVillageoisFirst(){let e=this.sortedRounds.indexOf("SECTAIRE"),r=this.sortedRounds.indexOf("VILLAGEOIS");this.sortedRounds.splice(r,1),this.sortedRounds.splice(e+1,0,"VILLAGEOIS")}resetRoundsOrder(){this.sortedRounds=[...hr]}static{this.\u0275fac=function(r){return new(r||o)}}static{this.\u0275prov=c({token:o,factory:o.\u0275fac,providedIn:"root"})}};var Ke=class extends m{constructor(){super("ANGE",d.ANGE);this.roundOrchestrationService=i(B)}prepareNewGame(r){return this.roundOrchestrationService.setVillageoisFirst(),super.prepareNewGame(r)}};var W=class o extends S{constructor(){super("store.needCleanAfterBouc",!1)}static{this.\u0275fac=function(r){return new(r||o)}}static{this.\u0275prov=c({token:o,factory:o.\u0275fac,providedIn:"root"})}};var Xe=class extends m{constructor(){super("BOUC",d.BOUC);this.afterDeathRoundQueue=i(T).state;this.needCleanAfterBouc=i(W).state}handleDeath(r,t){return t.killedBy===void 0?this.afterDeathRoundQueue.update(n=>[...n,"BOUC"]):this.roundHandlersService.removeHandler("BOUC"),r}cleanStatusesAfterDay(r){if(this.needCleanAfterBouc()){let t=r.reduce((n,a)=>a.role!=="IDIOT"||a.killedBy===void 0?[...n,a.id]:n,[]);return this.needCleanAfterBouc.set(!1),C(r,"NO_VOTE",t)}return r}};var qe=class extends m{constructor(){super("CHASSEUR",d.CHASSEUR);this.afterDeathRoundQueue=i(T).state}handleDeath(r,t){return this.afterDeathRoundQueue.update(n=>["CHASSEUR",...n]),r}};var $e=class extends m{constructor(){super("CHEVALIER",d.CHEVALIER)}handleDeath(e,r){let t;if(r.killedBy==="GRAND_MECHANT_LOUP")t=e.find(n=>n.role==="GRAND_MECHANT_LOUP")?.id;else if(r.killedBy==="LOUP_GAROU"){let n=e.indexOf(r);t=w(e,n,!0)?.id}return t!==void 0?I(e,"RUSTY_SWORD",[t]):e}cleanStatusesAfterDay(e){return e.some(r=>r.role==="CHEVALIER"&&r.isDead)?this.statusHandlersService.getHandler("RUSTY_SWORD").triggerAction(e):e}};var ze=class extends m{constructor(){super("CHIEN_LOUP",d.CHIEN_LOUP)}};var Ze=class extends m{constructor(){super("CORBEAU",d.CORBEAU)}cleanStatusesAfterDay(e){let r=e.find(t=>t.statuses.has("RAVEN"))?.id;return r!==void 0?C(e,"RAVEN",[r]):e}};var er=class extends m{constructor(){super("CUPIDON",d.CUPIDON)}};var rr=class extends m{constructor(){super("ENFANT_SAUVAGE",d.ENFANT_SAUVAGE)}};var tr=class extends m{constructor(){super("FRERE",d.FRERE)}handleDeath(e,r){return e.filter(t=>t.role==="FRERE").every(t=>t.isDead)&&this.roundHandlersService.removeHandler("FRERES"),e}};var or=class extends m{constructor(){super("GRAND_MECHANT_LOUP",d.GRAND_MECHANT_LOUP)}};var nr=class extends m{constructor(){super("IDIOT",d.IDIOT)}};var ar=class extends m{constructor(){super("JOUEUR_FLUTE",d.JOUEUR_FLUTE)}handleDeath(e,r){return this.victoryHandlersService.removeHandler("JOUEUR_FLUTE"),super.handleDeath(e,r)}};var ir=class extends m{constructor(){super("LOUP_BLANC",d.LOUP_BLANC)}handleDeath(e,r){return this.victoryHandlersService.removeHandler("LOUP_BLANC"),super.handleDeath(e,r)}};var sr=class extends m{constructor(){super("LOUP_GAROU",d.LOUP_GAROU)}handleDeath(e,r){return this.roundHandlersService.removeHandler("GRAND_MECHANT_LOUP"),e}};var lr=class extends m{constructor(){super("MONTREUR_OURS",d.MONTREUR_OURS)}};var dr=class extends m{constructor(){super("PERE_LOUPS",d.PERE_LOUPS)}};var ur=class extends m{constructor(){super("PETITE_FILLE",d.PETITE_FILLE)}};var mr=class extends m{constructor(){super("RENARD",d.RENARD)}};var cr=class extends m{constructor(){super("SALVATEUR",d.SALVATEUR)}cleanStatusesAfterDay(e){if(e.some(r=>r.role==="SALVATEUR"&&r.isDead)){let r=e.find(t=>t.statuses.has("PROTECTED"))?.id;if(r!==void 0)return C(e,"PROTECTED",[r])}return e}};var fr=class extends m{constructor(){super("SECTAIRE",d.SECTAIRE)}handleDeath(e,r){return this.victoryHandlersService.removeHandler("SECTAIRE"),super.handleDeath(e,r)}};var Er=class extends m{constructor(){super("SOEUR",d.SOEUR)}handleDeath(e,r){return e.filter(t=>t.role==="SOEUR").every(t=>t.isDead)&&this.roundHandlersService.removeHandler("SOEURS"),e}};var pr=class extends m{constructor(){super("SORCIERE",d.SORCIERE)}prepareNewGame(e){let r=super.prepareNewGame(e),t=r.find(n=>n.role==="SORCIERE")?.id;return t!==void 0&&(r=I(r,"HEALTH_POTION",[t]),r=I(r,"DEATH_POTION",[t])),r}};var Rr=class extends m{constructor(){super("VILLAGEOIS",d.VILLAGEOIS)}};var yr=class extends m{constructor(){super("VOLEUR",d.VOLEUR)}};var Pr=class extends m{constructor(){super("VOYANTE",d.VOYANTE)}};var d={NOT_SELECTED:void 0,VILLAGEOIS:{handler:Rr,rounds:[],statuses:[],victories:[]},LOUP_GAROU:{handler:sr,rounds:[],statuses:["WOLF_TARGET","DEVOURED"],victories:["LOUP_GAROU"]},CHASSEUR:{handler:qe,rounds:["CHASSEUR"],statuses:[],victories:[]},CUPIDON:{handler:er,rounds:["CUPIDON","AMOUREUX"],statuses:["LOVER"],victories:["AMOUREUX"]},PETITE_FILLE:{handler:ur,rounds:[],statuses:[],victories:[]},SORCIERE:{handler:pr,rounds:["SORCIERE_HEALTH","SORCIERE_KILL"],statuses:["HEALTH_POTION","DEATH_POTION"],victories:[]},VOLEUR:{handler:yr,rounds:["VOLEUR"],statuses:[],victories:[]},VOYANTE:{handler:Pr,rounds:["VOYANTE"],statuses:[],victories:[]},JOUEUR_FLUTE:{handler:ar,rounds:["JOUEUR_FLUTE","CHARMED"],statuses:["CHARMED"],victories:["JOUEUR_FLUTE"]},CORBEAU:{handler:Ze,rounds:["CORBEAU"],statuses:["RAVEN"],victories:[]},ENFANT_SAUVAGE:{handler:rr,rounds:["ENFANT_SAUVAGE"],statuses:["CHILD_MODEL"],victories:[]},SALVATEUR:{handler:cr,rounds:["SALVATEUR"],statuses:["PROTECTED"],victories:[]},GRAND_MECHANT_LOUP:{handler:or,rounds:["GRAND_MECHANT_LOUP"],statuses:["WOLF_TARGET","DEVOURED"],victories:["LOUP_GAROU"]},MONTREUR_OURS:{handler:lr,rounds:["MONTREUR_OURS"],statuses:[],victories:[]},RENARD:{handler:mr,rounds:["RENARD"],statuses:["NO_POWER"],victories:[]},CHIEN_LOUP:{handler:ze,rounds:["CHIEN_LOUP"],statuses:["WOLF_TARGET","DEVOURED"],victories:[]},SOEUR:{handler:Er,rounds:["SOEURS"],statuses:[],victories:[]},FRERE:{handler:tr,rounds:["FRERES"],statuses:[],victories:[]},LOUP_BLANC:{handler:ir,rounds:["LOUP_BLANC"],statuses:["WOLF_TARGET","DEVOURED"],victories:["LOUP_BLANC","LOUP_GAROU"]},ANGE:{handler:Ke,rounds:[],statuses:[],victories:["ANGE"]},ANCIEN:{handler:Ye,rounds:[],statuses:["INJURED"],victories:[]},IDIOT:{handler:nr,rounds:[],statuses:["NO_VOTE"],victories:[]},CHEVALIER:{handler:$e,rounds:[],statuses:["RUSTY_SWORD"],victories:[]},BOUC:{handler:Xe,rounds:["BOUC"],statuses:["NO_VOTE"],victories:[]},SECTAIRE:{handler:fr,rounds:["SECTAIRE"],statuses:["BLUE_TEAM","RED_TEAM"],victories:["SECTAIRE"]},PERE_LOUPS:{handler:dr,rounds:["PERE_LOUPS"],statuses:["WOLF_TARGET","NO_POWER","INFECTED","DEVOURED"],victories:["LOUP_GAROU"]}};var k=class o{constructor(){this.injector=i(G);this.currentPlayersState=i(N).state.asReadonly();this.roleHandlers=new Map;let e=this.currentPlayersState();e.length>0&&this.initHandlers(e)}initHandlers(e){F(this.injector,()=>{e.forEach(r=>{let t=r.role;if(!this.roleHandlers.has(t)){let n=this.createRoleHandler(t);this.roleHandlers.set(t,n)}})})}getHandler(e){if(this.roleHandlers.has(e))return this.roleHandlers.get(e);throw new Error(`RoleHandler for ${e} not initialized`)}getHandlers(){return Array.from(this.roleHandlers.values())}clearHandlers(){this.roleHandlers.clear()}createRoleHandler(e){if(d[e]!==void 0)return new d[e].handler;throw new Error(`Missing RoleHandler config for ${e}`)}static{this.\u0275fac=function(r){return new(r||o)}}static{this.\u0275prov=c({token:o,factory:o.\u0275fac,providedIn:"root"})}};var j=class o{constructor(){this.announcementService=i(H);this.roleHandlersService=i(k);this.statusHandlersService=i(V);this.knownDeaths=i($).state;this.deathsToAnnounce=i(q).state;this.afterDeathRoundQueue=i(T).state}getNextAfterDeathRound(){let e=this.afterDeathRoundQueue()[0];return e!==void 0&&this.afterDeathRoundQueue.update(r=>r.slice(1)),e}reset(){this.knownDeaths.set(new Set),this.deathsToAnnounce.set([]),this.afterDeathRoundQueue.set([])}handleNewDeaths(e){let r=this.statusHandlersService.getHandler("DEVOURED").triggerAction(e),t;do{t=r.filter(n=>n.isDead&&!this.knownDeaths().has(n.id));for(let n of t)r=this.handlePlayerDeath(r,n)}while(t.length>0);return r}announceDeaths(){if(this.deathsToAnnounce().length>0){let e=this.deathsToAnnounce().find(t=>t.killedBy==="CHEVALIER");e!==void 0&&this.announcementService.announce(6,{playerName:e.name}),this.announcementService.announceDeaths(this.deathsToAnnounce());let r=this.deathsToAnnounce().find(t=>t.role==="ANCIEN");r!==void 0&&ee(r)&&this.announcementService.announce(4),this.deathsToAnnounce.set([])}}handlePlayerDeath(e,r){this.knownDeaths.update(n=>(n.add(r.id),new Set(n))),this.deathsToAnnounce.update(n=>[...n,r]);let t=this.handlePlayerDeathStatuses(e,r);return this.handlePlayerDeathRole(t,r)}handlePlayerDeathStatuses(e,r){let t=e;return r.statuses.forEach(n=>{t=this.statusHandlersService.getHandler(n).handleDeath(t,r)}),t}handlePlayerDeathRole(e,r){return this.roleHandlersService.getHandler(r.role).handleDeath(e,r)}static{this.\u0275fac=function(r){return new(r||o)}}static{this.\u0275prov=c({token:o,factory:o.\u0275fac,providedIn:"root"})}};var Fr=class o{constructor(){this.router=i(Hr);this.roundHandlersService=i(b);this.victoryHandlersService=i(g);this.roundOrchestrationService=i(B);this.deathService=i(j);this.statusHandlersService=i(V);this.roleHandlersService=i(k);this.players=i(N).state;this.roundConfig=i(Q).state;this.dayCount=i(M).state;this.needCleanAfterBouc=i(W).state;this.cardList=i(Tr).state.asReadonly();this.isGameInProgress=Dr(()=>this.roundConfig()!==null)}createGame(e){let r=this.cardList();this.initGame(e,r),e.map(n=>n.role).includes("ANGE")?this.nextDayCount(-1):this.nextDayCount(0),this.setFirstRound(),this.router.navigate(["game"])}submitRoundAction(e,r,t){let n=this.roundConfig()?.round;if(n!==void 0){let a=this.roundHandlersService.getHandler(n);a!==void 0&&a.handleAction(this.players(),e,r,t).subscribe(s=>{this.setPlayers(s),this.nextRound()})}}initGame(e,r){this.roleHandlersService.clearHandlers(),this.roundHandlersService.clearHandlers(),this.statusHandlersService.clearHandlers(),this.victoryHandlersService.clearHandlers(),this.roundOrchestrationService.resetRoundsOrder(),this.roundHandlersService.initRequiredHandlers(),this.victoryHandlersService.initRequiredHandlers();let t=_r(e,r);this.roundHandlersService.initAsDefaultHandlers(t),this.roleHandlersService.initHandlers(e),this.statusHandlersService.initHandlers(e);let n=[...e];this.roleHandlersService.getHandlers().forEach(a=>n=a.prepareNewGame(n)),this.setPlayers(n)}setFirstRound(){let e=this.roundOrchestrationService.getFirstRound();this.setRound(e)}nextRound(){let e=this.roundConfig()?.round;if(e===void 0)throw new Error("No current round");e==="VOLEUR"?this.handleAfterVoleurRound():e==="PERE_LOUPS"&&this.handleAfterPereLoupRound();let r=this.roundHandlersService.getHandler(e);this.handleDaytimeDeaths(r);let t;try{t=this.roundOrchestrationService.getNextRound(e)}catch(s){if(this.checkVictory())return;throw s}let n=this.roundHandlersService.getHandler(t);this.handlerAfterLoupsEvents(n),t=this.handleAfterNightDeaths(r,e,n,t),!this.handleDayRound(r,n,t)&&(this.handleAfterDayEvents(r,n),e==="BOUC"&&this.needCleanAfterBouc.set(!0),this.setRound(t))}setRound(e){let r=this.roundHandlersService.getHandler(e);if(r!==void 0){let t=r.getRoundConfig(this.players(),this.cardList());this.roundConfig.set(t),r.type===2&&this.submitRoundAction([])}}setPlayers(e){this.players.set([...e])}nextDayCount(e){let r=(e??this.dayCount())+1;this.dayCount.set(r)}handleVictory(e){this.roundConfig.set(null),this.needCleanAfterBouc.set(!1),this.roundOrchestrationService.resetRounds(),this.deathService.reset(),this.roundHandlersService.clearHandlers(),this.victoryHandlersService.clearHandlers(),this.router.navigate(["victory"],{queryParams:{victory:e}})}handleDaytimeDeaths(e){if(e?.isDuringDay){let r=this.deathService.handleNewDeaths(this.players());this.setPlayers(r)}}handleAfterNightDeaths(e,r,t,n){if(t?.isDuringDay&&!e?.isDuringDay){let a=this.deathService.handleNewDeaths(this.players());return this.setPlayers(a),this.roundOrchestrationService.getNextRound(r)}return n}handleDayRound(e,r,t){return(r?.isDuringDay||e?.isDuringDay)&&t!=="CHASSEUR"?(this.deathService.announceDeaths(),this.checkVictory()):!1}checkVictory(){let e=(this.roundConfig()?.isDuringDay&&this.dayCount()===0)??!1,r=!this.roundConfig()?.isDuringDay&&this.dayCount()===1,t=this.victoryHandlersService.getVictory(this.players(),e||r);return t!==void 0?(this.handleVictory(t),!0):!1}handleAfterDayEvents(e,r){if(r!==void 0&&!r.isDuringDay&&e?.isDuringDay){let t=this.players();new Set(this.players().map(a=>a.role)).forEach(a=>{t=this.roleHandlersService.getHandler(a).cleanStatusesAfterDay(t)}),this.setPlayers(t),this.nextDayCount()}}handleAfterVoleurRound(){let e=[...this.players()];this.initGame(e,this.cardList())}handleAfterPereLoupRound(){this.cardList().selectedRoles.has("JOUEUR_FLUTE")&&this.players().find(r=>r.card==="JOUEUR_FLUTE")?.role==="LOUP_GAROU"&&(this.roundHandlersService.removeHandlersByRoles(["JOUEUR_FLUTE"]),this.victoryHandlersService.removeHandler("JOUEUR_FLUTE"))}handlerAfterLoupsEvents(e){let r=this.roundConfig()?.round,t=e?.getRoundConfig(this.players(),this.cardList())?.round;if(r!==void 0&&t!==void 0&&Sr.includes(r)&&!Sr.includes(t)){let n=[...this.players()];n.some(a=>a.statuses.has("WOLF_TARGET"))&&(n=this.statusHandlersService.getHandler("WOLF_TARGET").triggerAction(n)),n.some(a=>a.statuses.has("INFECTED"))&&(n=this.statusHandlersService.getHandler("INFECTED").triggerAction(n)),this.players.set(n)}}static{this.\u0275fac=function(r){return new(r||o)}}static{this.\u0275prov=c({token:o,factory:o.\u0275fac,providedIn:"root"})}};export{T as a,K as b,q as c,He as d,$ as e,Te as f,Qe as g,Je as h,Be as i,N as j,Q as k,M as l,W as m,Fr as n};

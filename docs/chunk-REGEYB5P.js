import{l as J}from"./chunk-SCEWJJJJ.js";import{a as O,b as Tr,c as Ir}from"./chunk-EFH6HX73.js";import{d as vr}from"./chunk-J6W7A42Q.js";import{$ as F,Ab as Hr,Bb as Ur,Q as f,V as i,Y as V,ba as Lr,ea as Dr,k as D,o as U}from"./chunk-FDHCW5RC.js";import{a as R,b as E}from"./chunk-2NFLSA4Y.js";var N=class o extends O{constructor(){super("store.currentPlayers",[])}convertStateToStored(e){return e.map(r=>E(R({},r),{statuses:Array.from(r.statuses)}))}convertStoredToState(e){return e.map(r=>E(R({},r),{statuses:new Set(r.statuses)}))}static \u0275fac=function(r){return new(r||o)};static \u0275prov=f({token:o,factory:o.\u0275fac,providedIn:"root"})};var Q=class o extends O{constructor(){super("store.currentRoundConfig",null)}static \u0275fac=function(r){return new(r||o)};static \u0275prov=f({token:o,factory:o.\u0275fac,providedIn:"root"})};var G=class o extends O{constructor(){super("store.dayCount",1)}static \u0275fac=function(r){return new(r||o)};static \u0275prov=f({token:o,factory:o.\u0275fac,providedIn:"root"})};var Or=["LOUP_GAROU","GRAND_MECHANT_LOUP","LOUP_BLANC","PERE_LOUPS"];var K=class o extends O{constructor(){super("store.announcementsQueue",[])}static \u0275fac=function(r){return new(r||o)};static \u0275prov=f({token:o,factory:o.\u0275fac,providedIn:"root"})};var Ar={0:{header:"Morts \xE0 annoncer"},1:{header:"Grognement de l'ours",message:"L'ours du montreur d'ours grogne"},3:{header:"Reniflement du renard",message:"<p>Non, ce groupe ne contient aucun loup-garou.</p><p>Le renard perd son pouvoir.</p>"},2:{header:"Reniflement du renard",message:"<p>Oui, ce groupe contient un loup-garou.</p><p>Le renard garde son pouvoir.</p>"},4:{header:"Perte des pouvoirs",message:"<p>L'Ancien du village a \xE9t\xE9 tu\xE9 par des innocents.</p><p>Tous les innocents perdent leurs pouvoirs.</p>"},5:{header:"Idiot graci\xE9",message:"<p>Les villageois d\xE9cide de gracier l'Idiot.</p><p>L'Idiot ne pourra plus voter.</p>"},6:{header:"Mort par l'\xE9p\xE9e rouill\xE9e",message:"{{ playerName }} a \xE9t\xE9 tu\xE9 par l'\xE9p\xE9e rouill\xE9e du chevalier."}};var v=class o{destroyRef=i(Lr);modalManager=i(J);announcementsQueue=i(K).state;isPresenting=Dr(!1);constructor(){Ur(()=>{this.announcementsQueue().length>0&&!this.isPresenting()&&this.showNextAnnouncement()})}announceDeaths(e){let t={header:"Morts \xE0 annoncer",message:`<ul>${e.map(a=>`<li>${a.name}</li>`).join("")}</ul>`};this.addAnnouncementToQueue(t)}announce(e,r){let t=Ar[e].message;t!==void 0&&r!==void 0&&Object.entries(r).forEach(([n,m])=>{let A=`{{\\s*${n}\\s*}}`,_=new RegExp(A,"g");t=t.replaceAll(_,m)});let a={header:Ar[e].header,message:t};this.addAnnouncementToQueue(a)}addAnnouncementToQueue(e){this.announcementsQueue.update(r=>[...r,e])}showNextAnnouncement(){this.isPresenting.set(!0);let e=this.announcementsQueue()[0];if(e===void 0){this.isPresenting.set(!1);return}this.announcementsQueue.update(r=>r.slice(1)),this.modalManager.showTextModal(e).pipe(Ir(this.destroyRef)).subscribe(()=>{this.isPresenting.set(!1)})}static \u0275fac=function(r){return new(r||o)};static \u0275prov=f({token:o,factory:o.\u0275fac,providedIn:"root"})};var T=class o extends O{constructor(){super("store.afterDeathRoundQueue",[])}static \u0275fac=function(r){return new(r||o)};static \u0275prov=f({token:o,factory:o.\u0275fac,providedIn:"root"})};var q=class o extends O{constructor(){super("store.deathsToAnnounce",[])}convertStateToStored(e){return e.map(r=>E(R({},r),{statuses:Array.from(r.statuses)}))}convertStoredToState(e){return e.map(r=>E(R({},r),{statuses:new Set(r.statuses)}))}static \u0275fac=function(r){return new(r||o)};static \u0275prov=f({token:o,factory:o.\u0275fac,providedIn:"root"})};var $=class o extends O{constructor(){super("store.knownDeaths",new Set)}convertStateToStored(e){return Array.from(e)}convertStoredToState(e){return new Set(e)}static \u0275fac=function(r){return new(r||o)};static \u0275prov=f({token:o,factory:o.\u0275fac,providedIn:"root"})};var z=["LOUP_GAROU","GRAND_MECHANT_LOUP","LOUP_BLANC","PERE_LOUPS"];var Z=["CHASSEUR","CUPIDON","PETITE_FILLE","SORCIERE","VOYANTE","CORBEAU","SALVATEUR","MONTREUR_OURS","RENARD","CHEVALIER","BOUC"];var P=(o,e)=>E(R({},o),{statuses:new Set([...o.statuses,e])}),L=(o,e)=>{let r=new Set(o.statuses);return r.delete(e),E(R({},o),{statuses:r})},I=(o,e,r)=>o.map(t=>r.includes(t.id)?P(t,e):t),C=(o,e,r)=>o.map(t=>r.includes(t.id)?L(t,e):t);function _r(o,e){let r=o.map(a=>a.role);return[...e.selectedRoles,"VILLAGEOIS","LOUP_GAROU"].filter(a=>!r.includes(a))}function S(o){return z.includes(o.role)||o.statuses.has("INFECTED")}function ee(o){return o.killedBy!==void 0&&["CHASSEUR","SORCIERE","VILLAGEOIS"].includes(o.killedBy)}function Nr(o){return o.map(e=>{if(e.role==="SORCIERE"){let r=L(e,"HEALTH_POTION");return r=L(r,"DEATH_POTION"),r.role="VILLAGEOIS",r}return Z.includes(e.role)?E(R({},e),{role:"VILLAGEOIS"}):e})}var Cr={NOT_SELECTED:[],VILLAGEOIS:[],LOUP_GAROU:["WOLF_TARGET","DEVOURED"],CHASSEUR:[],CUPIDON:["LOVER"],PETITE_FILLE:[],SORCIERE:["HEALTH_POTION","DEATH_POTION"],VOLEUR:[],VOYANTE:[],JOUEUR_FLUTE:["CHARMED"],CORBEAU:["RAVEN"],ENFANT_SAUVAGE:["CHILD_MODEL"],SALVATEUR:["PROTECTED"],GRAND_MECHANT_LOUP:["WOLF_TARGET","DEVOURED"],MONTREUR_OURS:[],RENARD:["NO_POWER"],CHIEN_LOUP:["WOLF_TARGET","DEVOURED"],SOEUR:[],FRERE:[],LOUP_BLANC:["WOLF_TARGET","DEVOURED"],ANGE:[],ANCIEN:["INJURED"],IDIOT:["NO_VOTE"],CHEVALIER:["RUSTY_SWORD"],BOUC:["NO_VOTE"],SECTAIRE:["BLUE_TEAM","RED_TEAM"],PERE_LOUPS:["WOLF_TARGET","NO_POWER","INFECTED","DEVOURED"]};var y=class{handleDeath(e,r){return e}triggerAction(e){return e}};var re=class extends y{afterDeathRoundQueue=i(T).state;handleDeath(e,r){return r.role!=="IDIOT"?(this.afterDeathRoundQueue.update(t=>[...t,"CAPITAINE"]),C(e,"CAPTAIN",[r.id])):e}};var te=class extends y{handleDeath(e,r){let t=[...e],a=t.findIndex(n=>n.role==="ENFANT_SAUVAGE");return a!==-1&&!t[a].isDead&&(t[a]=E(R({},t[a]),{role:"LOUP_GAROU"})),t}};var oe=class extends y{triggerAction(e){return e.map(r=>{if(r.statuses.has("DEVOURED")){let t=L(r,"DEVOURED");return t.isDead=!0,t}return r})}};var ae=class extends y{triggerAction(e){let r=e.findIndex(a=>a.role==="ANCIEN"),t=e[r];if(t?.statuses.has("INFECTED")&&!t?.statuses.has("INJURED")){let a=[...e];return a[r]=L(a[r],"INFECTED"),a[r]=P(a[r],"INJURED"),a}return e}};var gr=["NONE","ANGE","AMOUREUX","SECTAIRE","LOUP_BLANC","JOUEUR_FLUTE","LOUP_GAROU","VILLAGEOIS"];var ne=class{isVictorious(e){let r=e.filter(t=>!t.isDead);return r.length===2&&r.every(t=>t.statuses.has("LOVER"))}};var ie=class{isVictorious(e,r){return r&&(e.find(t=>t.role==="ANGE")?.isDead??!1)}};var se=class{isVictorious(e){let r=!e.find(a=>a.role==="JOUEUR_FLUTE")?.isDead,t=e.filter(a=>!a.isDead&&a.role!=="JOUEUR_FLUTE").every(a=>a.statuses.has("CHARMED"));return r&&t}};var le=class{isVictorious(e){let r=e.filter(t=>!t.isDead);return r.length===1&&r[0].role==="LOUP_BLANC"}};var de=class{isVictorious(e){return e.filter(r=>!r.isDead).every(S)}};var ue=class{isVictorious(e){return e.filter(r=>!r.isDead).length===0}};var me=class{isVictorious(e){let r=e.find(t=>t.role==="SECTAIRE");if(r){let t=r.statuses.has("BLUE_TEAM")?"BLUE_TEAM":"RED_TEAM";return!r.isDead&&e.filter(a=>!a.statuses.has(t)).every(a=>a.isDead)}return!1}};var fe=class{isVictorious(e){return e.filter(r=>!r.isDead).every(r=>!S(r))}};var Sr={NONE:ue,ANGE:ie,AMOUREUX:ne,JOUEUR_FLUTE:se,LOUP_BLANC:le,LOUP_GAROU:de,SECTAIRE:me,VILLAGEOIS:fe};var ce=class o extends O{constructor(){super("store.victoryHandlers",new Set)}convertStateToStored(e){return Array.from(e)}convertStoredToState(e){return new Set(e)}static \u0275fac=function(r){return new(r||o)};static \u0275prov=f({token:o,factory:o.\u0275fac,providedIn:"root"})};var b=class o{victoryHandlers=new Map;victoryHandlersState=i(ce).state;victoryPriorities=gr;constructor(){this.victoryHandlersState().forEach(e=>this.createVictoryHandler(e))}initRequiredHandlers(){this.createVictoryHandler("NONE"),this.createVictoryHandler("VILLAGEOIS")}removeHandler(e){this.victoryHandlers.delete(e),this.syncState()}getVictory(e,r){let t;for(let a of this.victoryPriorities)if(this.victoryHandlers.get(a)?.isVictorious(e,r)){t=a;break}return t}clearHandlers(){this.victoryHandlers.clear(),this.syncState()}createVictoryHandler(e){!this.victoryHandlers.has(e)&&Sr[e]!==void 0&&(this.victoryHandlers.set(e,new Sr[e]),this.syncState())}syncState(){this.victoryHandlersState.set(new Set(this.victoryHandlers.keys()))}static \u0275fac=function(r){return new(r||o)};static \u0275prov=f({token:o,factory:o.\u0275fac,providedIn:"root"})};var pe=class extends y{victoryHandlersManager=i(b);handleDeath(e,r){let t=[...e],a=t.findIndex(n=>n.statuses.has("LOVER")&&n.id!==r.id&&!n.isDead);return a>-1&&(t[a]=E(R({},t[a]),{isDead:!0})),this.victoryHandlersManager.removeHandler("AMOUREUX"),t}};var Re=class extends y{triggerAction(e){let r=e.findIndex(t=>t.statuses.has("RUSTY_SWORD"));if(r>-1){let t=[...e];return t[r]=L(t[r],"RUSTY_SWORD"),t[r].isDead=!0,t[r].killedBy="CHEVALIER",t}return e}};var Ee=class extends y{triggerAction(e){return e.map(r=>{if(r.statuses.has("WOLF_TARGET")){let t=L(r,"WOLF_TARGET");return!r.statuses.has("PROTECTED")||r.role==="PETITE_FILLE"?r.role==="ANCIEN"&&!r.statuses.has("INJURED")?t=P(t,"INJURED"):t=P(t,"DEVOURED"):t.killedBy=void 0,t}return r})}};var br={WOLF_TARGET:Ee,HEALTH_POTION:y,DEATH_POTION:y,CAPTAIN:re,LOVER:pe,INJURED:y,PROTECTED:y,NO_POWER:y,CHARMED:y,CHILD_MODEL:te,RAVEN:y,NO_VOTE:y,RUSTY_SWORD:Re,BLUE_TEAM:y,RED_TEAM:y,INFECTED:ae,DEVOURED:oe};var x=class o{injector=i(F);currentPlayersState=i(N).state.asReadonly();statusHandlers=new Map;defaultStatusHandler=new y;constructor(){let e=this.currentPlayersState();e.length>0&&this.initHandlers(e)}initHandlers(e){this.createStatusHandler("CAPTAIN"),e.forEach(r=>{Cr[r.role]?.forEach(t=>this.createStatusHandler(t))})}getHandler(e){if(this.statusHandlers.has(e))return this.statusHandlers.get(e);throw new Error(`StatusHandler for ${e} not initialized`)}clearHandlers(){this.statusHandlers.clear()}createStatusHandler(e){if(this.statusHandlers.has(e))return;let r=br[e];if(r===void 0)throw new Error(`Missing StatusHandler config for ${e}`);if(r.name===y.name){this.statusHandlers.set(e,this.defaultStatusHandler);return}V(this.injector,()=>{let t=new r;this.statusHandlers.set(e,t)})}static \u0275fac=function(r){return new(r||o)};static \u0275prov=f({token:o,factory:o.\u0275fac,providedIn:"root"})};var xr={NOT_SELECTED:[],VILLAGEOIS:[],LOUP_GAROU:[],CHASSEUR:["CHASSEUR"],CUPIDON:["CUPIDON","AMOUREUX"],PETITE_FILLE:[],SORCIERE:["SORCIERE_HEALTH","SORCIERE_KILL"],VOYANTE:["VOYANTE"],JOUEUR_FLUTE:["JOUEUR_FLUTE","CHARMED"],CORBEAU:["CORBEAU"],ENFANT_SAUVAGE:["ENFANT_SAUVAGE"],SALVATEUR:["SALVATEUR"],GRAND_MECHANT_LOUP:["GRAND_MECHANT_LOUP"],MONTREUR_OURS:["MONTREUR_OURS"],RENARD:["RENARD"],CHIEN_LOUP:["CHIEN_LOUP"],SOEUR:["SOEURS"],FRERE:["FRERES"],LOUP_BLANC:["LOUP_BLANC"],VOLEUR:["VOLEUR"],ANGE:[],ANCIEN:[],IDIOT:[],CHEVALIER:[],BOUC:["BOUC"],SECTAIRE:["SECTAIRE"],PERE_LOUPS:["PERE_LOUPS"]};var d=class{constructor(e,r,t,a=0){this.roundRole=e;this.isOnlyOnce=r;this.isDuringDay=t;this.type=a}handleAction(e,r){let t=[...e];return r.forEach(a=>{let n=t.findIndex(m=>m.id===a);if(n>-1){let m=this.affectSelectedPlayer(t[n]);t[n]=m}}),D(t)}getRoundConfig(e,r){return{round:this.roundRole,selectablePlayers:this.getSelectablePlayers(e).map(t=>t.id),selectableRoles:this.getSelectableRoles(e,r),maxSelectable:this.getMaxSelectable(e),minSelectable:this.getMinSelectable(e),isDuringDay:this.isDuringDay,type:this.type}}getSelectablePlayers(e){return[]}getSelectableRoles(e,r){return[]}getMaxSelectable(e){return this.getSelectablePlayers(e).length}getMinSelectable(e){return 0}affectSelectedPlayer(e){return e}};var ye=class extends d{constructor(){super("AMOUREUX",!0,!1)}};var Pe=class extends d{constructor(){super("BOUC",!0,!0,1)}handleAction(e,r){let t=e.reduce((n,m)=>!m.isDead&&!r.includes(m.id)?[...n,m.id]:n,[]),a=I(e,"NO_VOTE",t);return D(a)}getSelectablePlayers(e){return e.filter(r=>!r.isDead)}};var Oe=class extends d{constructor(){super("CAPITAINE",!0,!0,1)}getSelectablePlayers(e){return e.filter(r=>!r.isDead)}getMaxSelectable(e){return 1}getMinSelectable(e){return 1}affectSelectedPlayer(e){return P(e,"CAPTAIN")}};var Ae=class extends d{constructor(){super("CHARMED",!1,!1)}};var Se=class extends d{constructor(){super("CHASSEUR",!0,!0,1)}getSelectablePlayers(e){return e.filter(r=>r.role!=="CHASSEUR"&&!r.isDead)}getMaxSelectable(e){return 1}getMinSelectable(e){return 1}affectSelectedPlayer(e){return E(R({},e),{isDead:!0,killedBy:"CHASSEUR"})}};var he=class extends d{constructor(){super("CHIEN_LOUP",!0,!1,3)}handleAction(e,r,t){let a=[...e],n=a.findIndex(m=>m.role==="CHIEN_LOUP");if(n>-1&&t!==void 0){let m=E(R({},a[n]),{role:t});a[n]=m}return D(a)}getSelectablePlayers(e){return e.filter(r=>r.role==="CHIEN_LOUP")}getSelectableRoles(){return["VILLAGEOIS","LOUP_GAROU"]}getMaxSelectable(e){return 1}getMinSelectable(e){return 1}};var Le=class extends d{constructor(){super("CORBEAU",!1,!1,1)}getSelectablePlayers(e){return e.filter(r=>r.role!=="CORBEAU"&&!r.isDead)}getMaxSelectable(e){return 1}getMinSelectable(e){return 1}affectSelectedPlayer(e){return P(e,"RAVEN")}};var De=class extends d{constructor(){super("CUPIDON",!0,!1,1)}getSelectablePlayers(e){return e}getMaxSelectable(e){return 2}getMinSelectable(e){return 2}affectSelectedPlayer(e){return P(e,"LOVER")}};var He=class extends d{constructor(){super("ENFANT_SAUVAGE",!0,!1,1)}getSelectablePlayers(e){return e.filter(r=>r.role!=="ENFANT_SAUVAGE")}getMaxSelectable(e){return 1}getMinSelectable(e){return 1}affectSelectedPlayer(e){return P(e,"CHILD_MODEL")}};var Ue=class extends d{constructor(){super("FRERES",!0,!1)}};var ve=class extends d{constructor(){super("GRAND_MECHANT_LOUP",!1,!1,1)}getSelectablePlayers(e){return e.some(t=>S(t)&&t.isDead)?[]:e.filter(t=>!S(t)&&!t.isDead&&!t.statuses.has("WOLF_TARGET"))}getMaxSelectable(e){return 1}affectSelectedPlayer(e){let r=P(e,"WOLF_TARGET");return r.killedBy="GRAND_MECHANT_LOUP",r}};var Te=class extends d{constructor(){super("JOUEUR_FLUTE",!1,!1,1)}getSelectablePlayers(e){return e.filter(r=>r.role!=="JOUEUR_FLUTE"&&!r.isDead&&!r.statuses.has("CHARMED"))}getMaxSelectable(e){return 2}affectSelectedPlayer(e){return P(e,"CHARMED")}};var Ie=class extends d{constructor(){super("LOUP_BLANC",!1,!1,1)}getSelectablePlayers(e){return e.filter(r=>S(r)&&r.role!=="LOUP_BLANC"&&!r.isDead)}getMaxSelectable(e){return 1}affectSelectedPlayer(e){return E(R({},e),{isDead:!0,killedBy:"LOUP_BLANC"})}};var _e=class extends d{constructor(){super("LOUP_GAROU",!1,!1,1)}getSelectablePlayers(e){return this.areAllLoupGarouDead(e)?[]:e.filter(t=>!S(t)&&!t.isDead)}getMaxSelectable(e){return 1}getMinSelectable(e){return this.areAllLoupGarouDead(e)?0:1}affectSelectedPlayer(e){let r=P(e,"WOLF_TARGET");return r.killedBy="LOUP_GAROU",r}areAllLoupGarouDead(e){return e.filter(S).every(r=>r.isDead)}};function w(o,e,r=!1){let t=o.find((a,n)=>n>e&&!a.isDead&&(!r||S(a)));return t===void 0&&e>0&&(t=o.find((a,n)=>n<e&&!a.isDead&&(!r||S(a)))),t}function Ne(o,e){let r=e-1;r<0&&(r=o.length-1);let t;do t=o[r],r--,r<0&&(r=o.length-1);while(t.isDead&&r!==e);return t}var Ce=class extends d{announcer=i(v);constructor(){super("MONTREUR_OURS",!1,!0,2)}handleAction(e,r){let t=e.findIndex(a=>a.role==="MONTREUR_OURS");if(t>-1){if(e[t].statuses.has("INFECTED"))return this.announcer.announce(1),D([...e]);let n=w(e,t);if(S(n))return this.announcer.announce(1),D([...e]);let m=Ne(e,t);S(m)&&this.announcer.announce(1)}return D([...e])}};var ge=class extends d{constructor(){super("PERE_LOUPS",!1,!1,1)}handleAction(e,r){return super.handleAction(e,r).pipe(U(t=>{let a=[...t];if(r.length>0){let n=a.find(A=>A.role==="PERE_LOUPS")?.id;n!==void 0&&(a=I(a,"NO_POWER",[n]));let m=a.findIndex(A=>A.id===r[0]);m>-1&&a[m].role==="JOUEUR_FLUTE"&&(a[m]=E(R({},a[m]),{role:"LOUP_GAROU"}))}return a}))}getSelectablePlayers(e){return this.canInfect(e)?e.filter(r=>r.statuses.has("WOLF_TARGET")):[]}getMaxSelectable(e){return 1}affectSelectedPlayer(e){let r=L(e,"WOLF_TARGET");return r=P(r,"INFECTED"),r.killedBy=void 0,r}canInfect(e){return!(e.find(r=>r.role==="PERE_LOUPS")?.statuses.has("NO_POWER")??!1)}};var be=class extends d{announcer=i(v);constructor(){super("RENARD",!1,!1,1)}handleAction(e,r){let t=[...e];if(r.length>0)if(this.isFoxActionSuccess(e,r[0]))this.announcer.announce(2);else{this.announcer.announce(3);let a=t.findIndex(n=>n.role==="RENARD");a>-1&&(t[a]=P(t[a],"NO_POWER"))}return D(t)}getSelectablePlayers(e){return e.filter(r=>!r.isDead)}getMaxSelectable(e){return e.find(r=>r.role==="RENARD")?.statuses.has("NO_POWER")?0:1}isFoxActionSuccess(e,r){let t=e[r];if(S(t))return!0;let a=w(e,r);if(S(a))return!0;let n=Ne(e,r);return S(n)}};var xe=class extends d{constructor(){super("SALVATEUR",!1,!1,1)}handleAction(e,r){return super.handleAction(e,r).pipe(U(t=>{let a=t.findIndex(n=>n.statuses.has("PROTECTED")&&!r.includes(n.id));return a>-1&&(t[a]=L(t[a],"PROTECTED")),t}))}getSelectablePlayers(e){return e.filter(r=>!r.isDead&&!r.statuses.has("PROTECTED"))}getMaxSelectable(e){return 1}getMinSelectable(e){return 1}affectSelectedPlayer(e){return P(e,"PROTECTED")}};var Me=class extends d{constructor(){super("SECTAIRE",!0,!1,1)}handleAction(e,r){let t=e.map(a=>{let n=r.includes(a.id);return P(a,n?"BLUE_TEAM":"RED_TEAM")});return D(t)}getSelectablePlayers(e){return e}getMaxSelectable(e){return e.length-1}getMinSelectable(e){return 1}};var Ve=class extends d{constructor(){super("SOEURS",!0,!1)}};var Fe=class extends d{constructor(){super("SORCIERE_HEALTH",!1,!1,1)}handleAction(e,r){return super.handleAction(e,r).pipe(U(t=>{if(r.length>0){let a=t.findIndex(n=>n.role==="SORCIERE");a>-1&&(t[a]=L(t[a],"HEALTH_POTION"))}return t}))}getSelectablePlayers(e){return this.canHeal(e)?e.filter(r=>r.statuses.has("DEVOURED")):[]}getMaxSelectable(e){return 1}affectSelectedPlayer(e){let r=L(e,"DEVOURED");return r.killedBy=void 0,r}canHeal(e){return e.find(r=>r.role==="SORCIERE")?.statuses.has("HEALTH_POTION")??!1}};var Ge=class extends d{constructor(){super("SORCIERE_KILL",!1,!1,1)}handleAction(e,r){return super.handleAction(e,r).pipe(U(t=>{if(r.length>0){let a=t.findIndex(n=>n.role==="SORCIERE");a>-1&&(t[a]=L(t[a],"DEATH_POTION"))}return t}))}getSelectablePlayers(e){return this.canKill(e)?e.filter(r=>r.role!=="SORCIERE"&&!r.isDead):[]}getMaxSelectable(e){return 1}affectSelectedPlayer(e){return E(R({},e),{isDead:!0,killedBy:"SORCIERE"})}canKill(e){return e.find(r=>r.role==="SORCIERE")?.statuses.has("DEATH_POTION")??!1}};var we=class extends d{announcer=i(v);constructor(){super("VILLAGEOIS",!1,!0,1)}handleAction(e,r,t,a){if(a){let n=this.handleEquality(e);return D(n)}return super.handleAction(e,r)}getSelectablePlayers(e){return this.canVote(e)?e.filter(r=>!r.isDead):[]}getMaxSelectable(e){return 1}getMinSelectable(e){return this.canVote(e)?1:0}affectSelectedPlayer(e){let r=E(R({},e),{statuses:new Set(e.statuses)});return r.role==="IDIOT"&&r.killedBy===void 0&&!r.statuses.has("INFECTED")?(r.statuses.add("NO_VOTE"),this.announcer.announce(5)):r.isDead=!0,r.killedBy="VILLAGEOIS",r}canVote(e){return e.some(r=>!r.isDead&&!r.statuses.has("NO_VOTE"))}handleEquality(e){let r=[...e],t=r.findIndex(a=>a.role==="BOUC");return t>-1&&(r[t]=E(R({},r[t]),{isDead:!0,killedBy:void 0})),r}};function Mr(o,e){let r=o.map(m=>m.card),t=[],a=e.villageois-r.filter(m=>m==="VILLAGEOIS").length;for(let m=0;m<a;m++)t.push("VILLAGEOIS");let n=e.loupGarou-r.filter(m=>m==="LOUP_GAROU").length;for(let m=0;m<n;m++)t.push("LOUP_GAROU");if(e.selectedRoles.has("SOEUR")){let m=2-r.filter(A=>A==="SOEUR").length;for(let A=0;A<m;A++)t.push("SOEUR")}if(e.selectedRoles.has("FRERE")){let m=3-r.filter(A=>A==="FRERE").length;for(let A=0;A<m;A++)t.push("FRERE")}return Array.from(e.selectedRoles).filter(m=>m!=="SOEUR"&&m!=="FRERE").forEach(m=>{r.includes(m)||t.push(m)}),t}var Be=class extends d{constructor(){super("VOLEUR",!0,!1,3)}handleAction(e,r,t){let a=[...e],n=a.findIndex(m=>m.card==="VOLEUR");return n>-1&&t!==void 0&&(a[n]=E(R({},a[n]),{role:t,card:t})),D(a)}getSelectablePlayers(e){return e.filter(r=>r.role==="VOLEUR")}getSelectableRoles(e,r){if(r===void 0)throw new Error("VoleurRoundHandler need cardList");let t=Mr(e,r);if(t.length!==2)throw new Error("Incorrect number of cards not played");return t.every(n=>z.includes(n))?t:[...t,"VOLEUR"]}getMaxSelectable(e){return 1}getMinSelectable(e){return 1}};var je=class extends d{modalManager=i(J);constructor(){super("VOYANTE",!1,!1,1)}handleAction(e,r){if(r.length===0)return D(e);let t=e.find(a=>a.id===r[0]).card;return this.modalManager.showPlayerCard(t).pipe(U(()=>[...e]))}getSelectablePlayers(e){return e.filter(r=>r.role!=="VOYANTE"&&!r.isDead)}getMaxSelectable(e){return 1}};var Y={AMOUREUX:ye,BOUC:Pe,CAPITAINE:Oe,CHARMED:Ae,CHASSEUR:Se,CHIEN_LOUP:he,CORBEAU:Le,CUPIDON:De,ENFANT_SAUVAGE:He,FRERES:Ue,GRAND_MECHANT_LOUP:ve,JOUEUR_FLUTE:Te,LOUP_BLANC:Ie,LOUP_GAROU:_e,MONTREUR_OURS:Ce,PERE_LOUPS:ge,RENARD:be,SALVATEUR:xe,SECTAIRE:Me,SOEURS:Ve,SORCIERE_HEALTH:Fe,SORCIERE_KILL:Ge,VILLAGEOIS:we,VOLEUR:Be,VOYANTE:je};var We=class o extends O{constructor(){super("store.defaultRoundHandlers",new Set)}convertStateToStored(e){return Array.from(e)}convertStoredToState(e){return new Set(e)}static \u0275fac=function(r){return new(r||o)};static \u0275prov=f({token:o,factory:o.\u0275fac,providedIn:"root"})};var ke=class o extends O{constructor(){super("store.roundHandlers",new Set)}convertStateToStored(e){return Array.from(e)}convertStoredToState(e){return new Set(e)}static \u0275fac=function(r){return new(r||o)};static \u0275prov=f({token:o,factory:o.\u0275fac,providedIn:"root"})};var M=class o{injector=i(F);roundHandlers=new Map;roundHandlersState=i(ke).state;defaultRoundHandlersState=i(We).state;constructor(){this.roundHandlersState().forEach(e=>this.createRoundHandler(e)),this.defaultRoundHandlersState().forEach(e=>this.createDefaultRoundHandler(e))}initRequiredHandlers(){this.createRoundHandler("VILLAGEOIS"),this.createRoundHandler("LOUP_GAROU"),this.createRoundHandler("CAPITAINE")}initAsDefaultHandlers(e){new Set(e).forEach(t=>{xr[t].forEach(a=>this.createDefaultRoundHandler(a))})}getHandler(e){return this.roundHandlers.get(e)}removeHandlersByRoles(e){let r=new Set(e);Array.from(r.values()).flatMap(a=>l[a]?.rounds??[]).forEach(a=>this.removeHandler(a))}clearHandlers(){this.roundHandlers.clear(),this.roundHandlersState.set(new Set),this.defaultRoundHandlersState.set(new Set)}removeHandler(e){this.roundHandlers.delete(e),this.roundHandlersState().has(e)&&this.roundHandlersState.update(r=>(r.delete(e),new Set(r))),this.defaultRoundHandlersState().has(e)&&this.defaultRoundHandlersState.update(r=>(r.delete(e),new Set(r)))}createRoundHandler(e){if(!this.roundHandlers.has(e)){if(Y[e]===void 0)throw new Error(`Missing RoundHandler config for ${e}`);V(this.injector,()=>{let r=new Y[e];this.roundHandlers.set(e,r),this.roundHandlersState.update(t=>new Set([...t,e]))})}}createDefaultRoundHandler(e){if(!this.roundHandlers.has(e)){if(Y[e]===void 0)throw new Error(`Missing RoundHandler config for ${e}`);V(this.injector,()=>{let r=new Y[e],t=new d(e,r.isOnlyOnce,r.isDuringDay);this.roundHandlers.set(e,t),this.defaultRoundHandlersState.update(a=>new Set([...a,e]))})}}static \u0275fac=function(r){return new(r||o)};static \u0275prov=f({token:o,factory:o.\u0275fac,providedIn:"root"})};var u=class{constructor(e,r){this.role=e;this.metadata=r}roundHandlersManager=i(M);statusHandlersManager=i(x);victoryHandlersManager=i(b);prepareNewGame(e){return this.initRoundHandlers(),this.initStatusHandlers(),this.initVictoryHandlers(),e}handleDeath(e,r){return this.metadata.rounds.forEach(t=>this.roundHandlersManager.removeHandler(t)),e}cleanStatusesAfterDay(e){return e}initRoundHandlers(){this.metadata.rounds.forEach(e=>this.roundHandlersManager.createRoundHandler(e))}initStatusHandlers(){this.metadata.statuses.forEach(e=>this.statusHandlersManager.createStatusHandler(e))}initVictoryHandlers(){this.metadata.victories.forEach(e=>this.victoryHandlersManager.createVictoryHandler(e))}};var Ye=class extends u{constructor(){super("ANCIEN",l.ANCIEN)}handleDeath(e,r){return ee(r)?(this.roundHandlersManager.removeHandlersByRoles(Z),Nr(e)):e}};var hr=["SECTAIRE","VOLEUR","CUPIDON","VOYANTE","RENARD","AMOUREUX","SOEURS","FRERES","ENFANT_SAUVAGE","CORBEAU","SALVATEUR","CHIEN_LOUP","LOUP_GAROU","LOUP_BLANC","PERE_LOUPS","GRAND_MECHANT_LOUP","SORCIERE_HEALTH","SORCIERE_KILL","JOUEUR_FLUTE","CHARMED","MONTREUR_OURS","CAPITAINE","VILLAGEOIS"];var Je=class o extends O{constructor(){super("store.beforeDeathRound",null)}static \u0275fac=function(r){return new(r||o)};static \u0275prov=f({token:o,factory:o.\u0275fac,providedIn:"root"})};var Qe=class o extends O{constructor(){super("store.uniqueRoundsPassed",new Set)}convertStateToStored(e){return Array.from(e)}convertStoredToState(e){return new Set(e)}static \u0275fac=function(r){return new(r||o)};static \u0275prov=f({token:o,factory:o.\u0275fac,providedIn:"root"})};var B=class o{roundHandlersManager=i(M);deathHandler=i(j);sortedRounds=[...hr];uniqueRoundsPassed=i(Qe).state;beforeDeathRound=i(Je).state;dayCount=i(G).state.asReadonly();resetRounds(){this.uniqueRoundsPassed.set(new Set),this.beforeDeathRound.set(null)}getNextRound(e){this.roundHandlersManager.getHandler(e)?.isOnlyOnce&&this.uniqueRoundsPassed.update(Fr=>new Set([...Fr,e]));let t=this.deathHandler.getNextAfterDeathRound();if(t!==void 0)return this.beforeDeathRound.set(e),t;let a=this.beforeDeathRound();a&&(e=a,this.beforeDeathRound.set(null));let n=this.sortedRounds.indexOf(e),m,A=n+1;A>this.sortedRounds.length-1&&(A=0);let _;do _=this.sortedRounds[A],m=this.roundHandlersManager.getHandler(_),A++,A>this.sortedRounds.length-1&&(A=0);while((m===void 0||this.uniqueRoundsPassed().has(_))&&A!==n);if(m===void 0||this.uniqueRoundsPassed().has(_))throw new Error("No next round found");return _==="LOUP_BLANC"&&this.dayCount()%2!==0?this.getNextRound("LOUP_BLANC"):_}getFirstRound(){let e,r=0,t;do if(t=this.sortedRounds[r],e=this.roundHandlersManager.getHandler(t),r++,r>this.sortedRounds.length-1)throw new Error("No first round found");while(e===void 0);return t}setVillageoisFirst(){let e=this.sortedRounds.indexOf("SECTAIRE"),r=this.sortedRounds.indexOf("VILLAGEOIS");this.sortedRounds.splice(r,1),this.sortedRounds.splice(e+1,0,"VILLAGEOIS")}resetRoundsOrder(){this.sortedRounds=[...hr]}static \u0275fac=function(r){return new(r||o)};static \u0275prov=f({token:o,factory:o.\u0275fac,providedIn:"root"})};var Ke=class extends u{roundOrchestrator=i(B);constructor(){super("ANGE",l.ANGE)}prepareNewGame(e){return this.roundOrchestrator.setVillageoisFirst(),super.prepareNewGame(e)}};var W=class o extends O{constructor(){super("store.needCleanAfterBouc",!1)}static \u0275fac=function(r){return new(r||o)};static \u0275prov=f({token:o,factory:o.\u0275fac,providedIn:"root"})};var Xe=class extends u{afterDeathRoundQueue=i(T).state;needCleanAfterBouc=i(W).state;constructor(){super("BOUC",l.BOUC)}handleDeath(e,r){return r.killedBy===void 0?this.afterDeathRoundQueue.update(t=>[...t,"BOUC"]):this.roundHandlersManager.removeHandler("BOUC"),e}cleanStatusesAfterDay(e){if(this.needCleanAfterBouc()){let r=e.reduce((t,a)=>a.role!=="IDIOT"||a.killedBy===void 0?[...t,a.id]:t,[]);return this.needCleanAfterBouc.set(!1),C(e,"NO_VOTE",r)}return e}};var qe=class extends u{afterDeathRoundQueue=i(T).state;constructor(){super("CHASSEUR",l.CHASSEUR)}handleDeath(e,r){return this.afterDeathRoundQueue.update(t=>["CHASSEUR",...t]),e}};var $e=class extends u{constructor(){super("CHEVALIER",l.CHEVALIER)}handleDeath(e,r){let t;if(r.killedBy==="GRAND_MECHANT_LOUP")t=e.find(a=>a.role==="GRAND_MECHANT_LOUP")?.id;else if(r.killedBy==="LOUP_GAROU"){let a=e.indexOf(r);t=w(e,a,!0)?.id}return t!==void 0?I(e,"RUSTY_SWORD",[t]):e}cleanStatusesAfterDay(e){return e.some(r=>r.role==="CHEVALIER"&&r.isDead)?this.statusHandlersManager.getHandler("RUSTY_SWORD").triggerAction(e):e}};var ze=class extends u{constructor(){super("CHIEN_LOUP",l.CHIEN_LOUP)}};var Ze=class extends u{constructor(){super("CORBEAU",l.CORBEAU)}cleanStatusesAfterDay(e){let r=e.find(t=>t.statuses.has("RAVEN"))?.id;return r!==void 0?C(e,"RAVEN",[r]):e}};var er=class extends u{constructor(){super("CUPIDON",l.CUPIDON)}};var rr=class extends u{constructor(){super("ENFANT_SAUVAGE",l.ENFANT_SAUVAGE)}};var tr=class extends u{constructor(){super("FRERE",l.FRERE)}handleDeath(e,r){return e.filter(t=>t.role==="FRERE").every(t=>t.isDead)&&this.roundHandlersManager.removeHandler("FRERES"),e}};var or=class extends u{constructor(){super("GRAND_MECHANT_LOUP",l.GRAND_MECHANT_LOUP)}};var ar=class extends u{constructor(){super("IDIOT",l.IDIOT)}};var nr=class extends u{constructor(){super("JOUEUR_FLUTE",l.JOUEUR_FLUTE)}handleDeath(e,r){return this.victoryHandlersManager.removeHandler("JOUEUR_FLUTE"),super.handleDeath(e,r)}};var ir=class extends u{constructor(){super("LOUP_BLANC",l.LOUP_BLANC)}handleDeath(e,r){return this.victoryHandlersManager.removeHandler("LOUP_BLANC"),super.handleDeath(e,r)}};var sr=class extends u{constructor(){super("LOUP_GAROU",l.LOUP_GAROU)}handleDeath(e,r){return this.roundHandlersManager.removeHandler("GRAND_MECHANT_LOUP"),e}};var lr=class extends u{constructor(){super("MONTREUR_OURS",l.MONTREUR_OURS)}};var dr=class extends u{constructor(){super("PERE_LOUPS",l.PERE_LOUPS)}};var ur=class extends u{constructor(){super("PETITE_FILLE",l.PETITE_FILLE)}};var mr=class extends u{constructor(){super("RENARD",l.RENARD)}};var fr=class extends u{constructor(){super("SALVATEUR",l.SALVATEUR)}cleanStatusesAfterDay(e){if(e.some(r=>r.role==="SALVATEUR"&&r.isDead)){let r=e.find(t=>t.statuses.has("PROTECTED"))?.id;if(r!==void 0)return C(e,"PROTECTED",[r])}return e}};var cr=class extends u{constructor(){super("SECTAIRE",l.SECTAIRE)}handleDeath(e,r){return this.victoryHandlersManager.removeHandler("SECTAIRE"),super.handleDeath(e,r)}};var pr=class extends u{constructor(){super("SOEUR",l.SOEUR)}handleDeath(e,r){return e.filter(t=>t.role==="SOEUR").every(t=>t.isDead)&&this.roundHandlersManager.removeHandler("SOEURS"),e}};var Rr=class extends u{constructor(){super("SORCIERE",l.SORCIERE)}prepareNewGame(e){let r=super.prepareNewGame(e),t=r.find(a=>a.role==="SORCIERE")?.id;return t!==void 0&&(r=I(r,"HEALTH_POTION",[t]),r=I(r,"DEATH_POTION",[t])),r}};var Er=class extends u{constructor(){super("VILLAGEOIS",l.VILLAGEOIS)}};var yr=class extends u{constructor(){super("VOLEUR",l.VOLEUR)}};var Pr=class extends u{constructor(){super("VOYANTE",l.VOYANTE)}};var l={NOT_SELECTED:void 0,VILLAGEOIS:{handler:Er,rounds:[],statuses:[],victories:[]},LOUP_GAROU:{handler:sr,rounds:[],statuses:["WOLF_TARGET","DEVOURED"],victories:["LOUP_GAROU"]},CHASSEUR:{handler:qe,rounds:["CHASSEUR"],statuses:[],victories:[]},CUPIDON:{handler:er,rounds:["CUPIDON","AMOUREUX"],statuses:["LOVER"],victories:["AMOUREUX"]},PETITE_FILLE:{handler:ur,rounds:[],statuses:[],victories:[]},SORCIERE:{handler:Rr,rounds:["SORCIERE_HEALTH","SORCIERE_KILL"],statuses:["HEALTH_POTION","DEATH_POTION"],victories:[]},VOLEUR:{handler:yr,rounds:["VOLEUR"],statuses:[],victories:[]},VOYANTE:{handler:Pr,rounds:["VOYANTE"],statuses:[],victories:[]},JOUEUR_FLUTE:{handler:nr,rounds:["JOUEUR_FLUTE","CHARMED"],statuses:["CHARMED"],victories:["JOUEUR_FLUTE"]},CORBEAU:{handler:Ze,rounds:["CORBEAU"],statuses:["RAVEN"],victories:[]},ENFANT_SAUVAGE:{handler:rr,rounds:["ENFANT_SAUVAGE"],statuses:["CHILD_MODEL"],victories:[]},SALVATEUR:{handler:fr,rounds:["SALVATEUR"],statuses:["PROTECTED"],victories:[]},GRAND_MECHANT_LOUP:{handler:or,rounds:["GRAND_MECHANT_LOUP"],statuses:["WOLF_TARGET","DEVOURED"],victories:["LOUP_GAROU"]},MONTREUR_OURS:{handler:lr,rounds:["MONTREUR_OURS"],statuses:[],victories:[]},RENARD:{handler:mr,rounds:["RENARD"],statuses:["NO_POWER"],victories:[]},CHIEN_LOUP:{handler:ze,rounds:["CHIEN_LOUP"],statuses:["WOLF_TARGET","DEVOURED"],victories:[]},SOEUR:{handler:pr,rounds:["SOEURS"],statuses:[],victories:[]},FRERE:{handler:tr,rounds:["FRERES"],statuses:[],victories:[]},LOUP_BLANC:{handler:ir,rounds:["LOUP_BLANC"],statuses:["WOLF_TARGET","DEVOURED"],victories:["LOUP_BLANC","LOUP_GAROU"]},ANGE:{handler:Ke,rounds:[],statuses:[],victories:["ANGE"]},ANCIEN:{handler:Ye,rounds:[],statuses:["INJURED"],victories:[]},IDIOT:{handler:ar,rounds:[],statuses:["NO_VOTE"],victories:[]},CHEVALIER:{handler:$e,rounds:[],statuses:["RUSTY_SWORD"],victories:[]},BOUC:{handler:Xe,rounds:["BOUC"],statuses:["NO_VOTE"],victories:[]},SECTAIRE:{handler:cr,rounds:["SECTAIRE"],statuses:["BLUE_TEAM","RED_TEAM"],victories:["SECTAIRE"]},PERE_LOUPS:{handler:dr,rounds:["PERE_LOUPS"],statuses:["WOLF_TARGET","NO_POWER","INFECTED","DEVOURED"],victories:["LOUP_GAROU"]}};var k=class o{injector=i(F);currentPlayersState=i(N).state.asReadonly();roleHandlers=new Map;constructor(){let e=this.currentPlayersState();e.length>0&&this.initHandlers(e)}initHandlers(e){V(this.injector,()=>{e.forEach(r=>{let t=r.role;if(!this.roleHandlers.has(t)){let a=this.createRoleHandler(t);this.roleHandlers.set(t,a)}})})}getHandler(e){if(this.roleHandlers.has(e))return this.roleHandlers.get(e);throw new Error(`RoleHandler for ${e} not initialized`)}getHandlers(){return Array.from(this.roleHandlers.values())}clearHandlers(){this.roleHandlers.clear()}createRoleHandler(e){if(l[e]!==void 0)return new l[e].handler;throw new Error(`Missing RoleHandler config for ${e}`)}static \u0275fac=function(r){return new(r||o)};static \u0275prov=f({token:o,factory:o.\u0275fac,providedIn:"root"})};var j=class o{announcer=i(v);roleHandlersManager=i(k);statusHandlersManager=i(x);knownDeaths=i($).state;deathsToAnnounce=i(q).state;afterDeathRoundQueue=i(T).state;getNextAfterDeathRound(){let e=this.afterDeathRoundQueue()[0];return e!==void 0&&this.afterDeathRoundQueue.update(r=>r.slice(1)),e}reset(){this.knownDeaths.set(new Set),this.deathsToAnnounce.set([]),this.afterDeathRoundQueue.set([])}handleNewDeaths(e){let r=this.statusHandlersManager.getHandler("DEVOURED").triggerAction(e),t;do{t=r.filter(a=>a.isDead&&!this.knownDeaths().has(a.id));for(let a of t)r=this.handlePlayerDeath(r,a)}while(t.length>0);return r}announceDeaths(){if(this.deathsToAnnounce().length>0){let e=this.deathsToAnnounce().find(t=>t.killedBy==="CHEVALIER");e!==void 0&&this.announcer.announce(6,{playerName:e.name}),this.announcer.announceDeaths(this.deathsToAnnounce());let r=this.deathsToAnnounce().find(t=>t.role==="ANCIEN");r!==void 0&&ee(r)&&this.announcer.announce(4),this.deathsToAnnounce.set([])}}handlePlayerDeath(e,r){this.knownDeaths.update(a=>(a.add(r.id),new Set(a))),this.deathsToAnnounce.update(a=>[...a,r]);let t=this.handlePlayerDeathStatuses(e,r);return this.handlePlayerDeathRole(t,r)}handlePlayerDeathStatuses(e,r){let t=e;return r.statuses.forEach(a=>{t=this.statusHandlersManager.getHandler(a).handleDeath(t,r)}),t}handlePlayerDeathRole(e,r){return this.roleHandlersManager.getHandler(r.role).handleDeath(e,r)}static \u0275fac=function(r){return new(r||o)};static \u0275prov=f({token:o,factory:o.\u0275fac,providedIn:"root"})};var Vr=class o{router=i(vr);roundHandlersManager=i(M);victoryHandlersManager=i(b);roundOrchestrator=i(B);deathHandler=i(j);statusHandlersManager=i(x);roleHandlersManager=i(k);players=i(N).state;roundConfig=i(Q).state;dayCount=i(G).state;needCleanAfterBouc=i(W).state;cardList=i(Tr).state.asReadonly();isGameInProgress=Hr(()=>this.roundConfig()!==null);createGame(e){let r=this.cardList();this.initGame(e,r),e.map(a=>a.role).includes("ANGE")?this.nextDayCount(-1):this.nextDayCount(0),this.setFirstRound(),this.router.navigate(["current-game"])}submitRoundAction(e,r,t){let a=this.roundConfig()?.round;if(a!==void 0){let n=this.roundHandlersManager.getHandler(a);n!==void 0&&n.handleAction(this.players(),e,r,t).subscribe(m=>{this.setPlayers(m),this.nextRound()})}}initGame(e,r){this.roleHandlersManager.clearHandlers(),this.roundHandlersManager.clearHandlers(),this.statusHandlersManager.clearHandlers(),this.victoryHandlersManager.clearHandlers(),this.roundOrchestrator.resetRoundsOrder(),this.roundHandlersManager.initRequiredHandlers(),this.victoryHandlersManager.initRequiredHandlers();let t=_r(e,r);this.roundHandlersManager.initAsDefaultHandlers(t),this.roleHandlersManager.initHandlers(e),this.statusHandlersManager.initHandlers(e);let a=[...e];this.roleHandlersManager.getHandlers().forEach(n=>a=n.prepareNewGame(a)),this.setPlayers(a)}setFirstRound(){let e=this.roundOrchestrator.getFirstRound();this.setRound(e)}nextRound(){let e=this.roundConfig()?.round;if(e===void 0)throw new Error("No current round");e==="VOLEUR"?this.handleAfterVoleurRound():e==="PERE_LOUPS"&&this.handleAfterPereLoupRound();let r=this.roundHandlersManager.getHandler(e);this.handleDaytimeDeaths(r);let t;try{t=this.roundOrchestrator.getNextRound(e)}catch(m){if(this.checkVictory())return;throw m}let a=this.roundHandlersManager.getHandler(t);this.handlerAfterLoupsEvents(a),t=this.handleAfterNightDeaths(r,e,a,t),!this.handleDayRound(r,a,t)&&(this.handleAfterDayEvents(r,a),e==="BOUC"&&this.needCleanAfterBouc.set(!0),this.setRound(t))}setRound(e){let r=this.roundHandlersManager.getHandler(e);if(r!==void 0){let t=r.getRoundConfig(this.players(),this.cardList());this.roundConfig.set(t),r.type===2&&this.submitRoundAction([])}}setPlayers(e){this.players.set([...e])}nextDayCount(e){let r=(e??this.dayCount())+1;this.dayCount.set(r)}handleVictory(e){this.roundConfig.set(null),this.needCleanAfterBouc.set(!1),this.roundOrchestrator.resetRounds(),this.deathHandler.reset(),this.roundHandlersManager.clearHandlers(),this.victoryHandlersManager.clearHandlers(),this.router.navigate(["victory"],{queryParams:{victory:e}})}handleDaytimeDeaths(e){if(e?.isDuringDay){let r=this.deathHandler.handleNewDeaths(this.players());this.setPlayers(r)}}handleAfterNightDeaths(e,r,t,a){if(t?.isDuringDay&&!e?.isDuringDay){let n=this.deathHandler.handleNewDeaths(this.players());return this.setPlayers(n),this.roundOrchestrator.getNextRound(r)}return a}handleDayRound(e,r,t){return(r?.isDuringDay||e?.isDuringDay)&&t!=="CHASSEUR"?(this.deathHandler.announceDeaths(),this.checkVictory()):!1}checkVictory(){let e=(this.roundConfig()?.isDuringDay&&this.dayCount()===0)??!1,r=!this.roundConfig()?.isDuringDay&&this.dayCount()===1,t=this.victoryHandlersManager.getVictory(this.players(),e||r);return t!==void 0?(this.handleVictory(t),!0):!1}handleAfterDayEvents(e,r){if(r!==void 0&&!r.isDuringDay&&e?.isDuringDay){let t=this.players();new Set(this.players().map(n=>n.role)).forEach(n=>{t=this.roleHandlersManager.getHandler(n).cleanStatusesAfterDay(t)}),this.setPlayers(t),this.nextDayCount()}}handleAfterVoleurRound(){let e=[...this.players()];this.initGame(e,this.cardList())}handleAfterPereLoupRound(){this.cardList().selectedRoles.has("JOUEUR_FLUTE")&&this.players().find(r=>r.card==="JOUEUR_FLUTE")?.role==="LOUP_GAROU"&&(this.roundHandlersManager.removeHandlersByRoles(["JOUEUR_FLUTE"]),this.victoryHandlersManager.removeHandler("JOUEUR_FLUTE"))}handlerAfterLoupsEvents(e){let r=this.roundConfig()?.round,t=e?.getRoundConfig(this.players(),this.cardList())?.round;if(r!==void 0&&t!==void 0&&Or.includes(r)&&!Or.includes(t)){let a=[...this.players()];a.some(n=>n.statuses.has("WOLF_TARGET"))&&(a=this.statusHandlersManager.getHandler("WOLF_TARGET").triggerAction(a)),a.some(n=>n.statuses.has("INFECTED"))&&(a=this.statusHandlersManager.getHandler("INFECTED").triggerAction(a)),this.players.set(a)}}static \u0275fac=function(r){return new(r||o)};static \u0275prov=f({token:o,factory:o.\u0275fac,providedIn:"root"})};export{T as a,K as b,q as c,We as d,$ as e,ke as f,Qe as g,Je as h,ce as i,N as j,Q as k,G as l,W as m,Vr as n};
